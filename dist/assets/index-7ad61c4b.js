import{G as e,C as t,T as i,P as n,A as a}from"./vendor-db0ba0ad.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var s=(e=>(e[e.EMPTY=0]="EMPTY",e[e.FILLED=1]="FILLED",e[e.PREVIEW=2]="PREVIEW",e[e.HIGHLIGHTED=3]="HIGHLIGHTED",e[e.FROZEN=4]="FROZEN",e[e.BOMB=5]="BOMB",e))(s||{}),o=(e=>(e.CLASSIC="classic",e.LEVEL="level",e.TIMED="timed",e.DAILY="daily",e))(o||{});class r{static shapes=[{id:"single",name:"单格",pattern:[[1]],color:"#ffff00",rotatable:!1,rarity:1},{id:"line2h",name:"直线2(横)",pattern:[[1,1]],color:"#00ff00",rotatable:!0,rarity:1},{id:"line2v",name:"直线2(竖)",pattern:[[1],[1]],color:"#00ff00",rotatable:!0,rarity:1},{id:"line3h",name:"直线3(横)",pattern:[[1,1,1]],color:"#00ffff",rotatable:!0,rarity:2},{id:"line3v",name:"直线3(竖)",pattern:[[1],[1],[1]],color:"#00ffff",rotatable:!0,rarity:2},{id:"l3_1",name:"L形3-1",pattern:[[1,1],[1,0]],color:"#ff8000",rotatable:!0,rarity:2},{id:"l3_2",name:"L形3-2",pattern:[[1,0],[1,1]],color:"#ff8000",rotatable:!0,rarity:2},{id:"i_piece",name:"I形",pattern:[[1,1,1,1]],color:"#00ffff",rotatable:!0,rarity:3},{id:"o_piece",name:"O形",pattern:[[1,1],[1,1]],color:"#ffff00",rotatable:!1,rarity:3},{id:"t_piece",name:"T形",pattern:[[0,1,0],[1,1,1]],color:"#800080",rotatable:!0,rarity:3},{id:"l_piece",name:"L形",pattern:[[1,0,0],[1,1,1]],color:"#ff8000",rotatable:!0,rarity:3},{id:"j_piece",name:"J形",pattern:[[0,0,1],[1,1,1]],color:"#0000ff",rotatable:!0,rarity:3},{id:"s_piece",name:"S形",pattern:[[0,1,1],[1,1,0]],color:"#00ff00",rotatable:!0,rarity:3},{id:"z_piece",name:"Z形",pattern:[[1,1,0],[0,1,1]],color:"#ff0000",rotatable:!0,rarity:3},{id:"p_piece",name:"P形五格",pattern:[[1,1],[1,1],[1,0]],color:"#ff69b4",rotatable:!0,rarity:4},{id:"u_piece",name:"U形五格",pattern:[[1,0,1],[1,1,1]],color:"#ffa500",rotatable:!0,rarity:4},{id:"w_piece",name:"W形五格",pattern:[[1,0,0],[1,1,0],[0,1,1]],color:"#8a2be2",rotatable:!0,rarity:4},{id:"y_piece",name:"Y形五格",pattern:[[0,1],[1,1],[0,1],[0,1]],color:"#20b2aa",rotatable:!0,rarity:4},{id:"x_piece",name:"X形五格",pattern:[[0,1,0],[1,1,1],[0,1,0]],color:"#dc143c",rotatable:!0,rarity:4},{id:"n_piece",name:"N形五格",pattern:[[0,1,1,1],[1,1,0,0]],color:"#9acd32",rotatable:!0,rarity:4},{id:"f_piece",name:"F形五格",pattern:[[0,1,1],[1,1,0],[0,1,0]],color:"#4169e1",rotatable:!0,rarity:4},{id:"plus_big",name:"大十字",pattern:[[0,1,0],[1,1,1],[0,1,0]],color:"#ff6347",rotatable:!1,rarity:4},{id:"corner_6",name:"角形六格",pattern:[[1,1,1],[1,0,0],[1,0,0],[1,0,0]],color:"#dda0dd",rotatable:!0,rarity:5},{id:"stairs_6",name:"阶梯六格",pattern:[[1,0,0],[1,1,0],[0,1,1],[0,0,1]],color:"#b22222",rotatable:!0,rarity:5},{id:"big_l",name:"大L形",pattern:[[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,1,1,1]],color:"#800000",rotatable:!0,rarity:5},{id:"mega_cross",name:"巨型十字",pattern:[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],color:"#2f4f4f",rotatable:!1,rarity:6},{id:"diamond_5",name:"钻石五格",pattern:[[0,1,0],[1,1,1],[1,0,1]],color:"#00ced1",rotatable:!0,rarity:4},{id:"claw_5",name:"爪形五格",pattern:[[1,0,1],[1,1,1],[0,1,0]],color:"#ff1493",rotatable:!0,rarity:4},{id:"hook_5",name:"钩形五格",pattern:[[1,1,1,1],[0,0,0,1],[0,0,1,0]],color:"#32cd32",rotatable:!0,rarity:4},{id:"line5",name:"五格直线",pattern:[[1,1,1,1,1]],color:"#ff4500",rotatable:!0,rarity:4},{id:"line6",name:"六格直线",pattern:[[1,1,1,1,1,1]],color:"#8b0000",rotatable:!0,rarity:5},{id:"square3",name:"3x3方形",pattern:[[1,1,1],[1,1,1],[1,1,1]],color:"#483d8b",rotatable:!1,rarity:5},{id:"spiral_5",name:"螺旋五格",pattern:[[1,1,1],[0,0,1],[1,1,1]],color:"#ba55d3",rotatable:!0,rarity:4},{id:"zigzag_6",name:"锯齿六格",pattern:[[1,0,1,0],[1,1,1,1],[0,1,0,1]],color:"#cd853f",rotatable:!0,rarity:5}];static getAllShapes(){return[...this.shapes]}static getShapesByDifficulty(e){return e<=0?this.shapes.filter((e=>1===e.rarity&&1===e.pattern.length&&1===e.pattern[0].length)):e<=1?this.shapes.filter((e=>e.rarity<=1)):e<=2?this.shapes.filter((e=>e.rarity<=2)):e<=3?this.shapes.filter((e=>e.rarity<=3)):e<=4?this.shapes.filter((e=>e.rarity<=4)):e<=5?this.shapes.filter((e=>e.rarity<=5)):this.shapes}static getRandomShape(e=1){const t=this.getShapesByDifficulty(e),i=t.map((t=>{const i=8-t.rarity;let n=0;return e>=3&&(n=Math.min(4,Math.floor(1.5*(e-2))),t.rarity>=4&&(n+=Math.min(3,e-3)),t.rarity>=5&&(n+=Math.min(2,e-4)),t.rarity>=6&&(n+=Math.min(2,e-5))),e>=6&&t.rarity>=5&&(n+=3),Math.max(1,i+n)})),n=i.reduce(((e,t)=>e+t),0);let a=Math.random()*n;for(let s=0;s<t.length;s++)if(a-=i[s],a<=0)return t[s];return t[t.length-1]}static rotateShape(e){const t=e.length,i=e[0].length,n=[];for(let a=0;a<i;a++){n[a]=[];for(let i=t-1;i>=0;i--)n[a][t-1-i]=e[i][a]}return n}static getShapeBounds(e){return{width:e[0].length,height:e.length}}}class l{level=1;nextId=1;constructor(e=1){this.level=e}generateBlock(){const e=r.getRandomShape(this.level);return{id:"block_"+this.nextId++,shape:e,x:0,y:0,rotation:0}}generateCandidateBlocks(e=3){const t=[];for(let i=0;i<e;i++)t.push(this.generateBlock());return t}setLevel(e){this.level=e}getLevel(){return this.level}}class c{_currentLevel=1;_levelConfigs=new Map;_levelProgress=new Map;constructor(){this.initializeLevels(),this.loadProgress()}initializeLevels(){for(let e=1;e<=10;e++){let t;t=e<=3?10+5*(e-1):25+15*(e-4),this._levelConfigs.set(e,{level:e,targetScore:t,minScore:t,mediumScore:Math.floor(1.5*t),maxScore:2*t,maxBlockRarity:1,hasTimeLimit:!1,specialMechanics:e<=3?["tutorial"]:[],description:`新手关卡 ${e} - 学习消除技巧`})}for(let e=11;e<=30;e++){const t=200+80*(e-11);this._levelConfigs.set(e,{level:e,targetScore:t,minScore:t,mediumScore:Math.floor(1.5*t),maxScore:2*t,maxBlockRarity:2,hasTimeLimit:!1,specialMechanics:["preview3blocks"],description:`基础关卡 ${e} - 引入经典俄罗斯方块`})}for(let e=31;e<=60;e++){const t=1800+100*(e-31);this._levelConfigs.set(e,{level:e,targetScore:t,minScore:t,mediumScore:Math.floor(1.5*t),maxScore:2*t,maxBlockRarity:3,hasTimeLimit:e>40,timeLimitSeconds:e>40?240:void 0,specialMechanics:["preview3blocks","timeLimit"],description:`进阶关卡 ${e} - ${e>40?"限时挑战":"策略关卡"}`})}for(let e=61;e<=100;e++){const t=5e3+150*(e-61);let i=4;e>=80&&(i=5),e>=95&&(i=6),this._levelConfigs.set(e,{level:e,targetScore:t,minScore:t,mediumScore:Math.floor(1.5*t),maxScore:2*t,maxBlockRarity:i,hasTimeLimit:!0,timeLimitSeconds:Math.max(180,300-3*(e-61)),specialMechanics:["obstacles","frozenBlocks","timeLimit"],description:`专家关卡 ${e} - ${e>=95?"巨型方块挑战":e>=80?"大型方块挑战":"障碍与冰冻方块"}`})}console.log(`🎮 Initialized ${this._levelConfigs.size} levels`)}loadProgress(){try{const e=localStorage.getItem("blockPuzzle_levelProgress");if(e){const t=JSON.parse(e);for(const[e,i]of Object.entries(t))this._levelProgress.set(parseInt(e),i)}}catch(e){console.warn("Failed to load level progress:",e)}this._levelProgress.has(1)||this._levelProgress.set(1,{level:1,completed:!1,stars:0,bestScore:0,attempts:0})}saveProgress(){try{const e={};for(const[t,i]of this._levelProgress.entries())e[t]=i;localStorage.setItem("blockPuzzle_levelProgress",JSON.stringify(e))}catch(e){console.warn("Failed to save level progress:",e)}}getCurrentLevel(){return this._currentLevel}setCurrentLevel(e){return!!this._levelConfigs.has(e)&&(e>1&&!this.isLevelUnlocked(e)?(console.warn(`Level ${e} is not unlocked yet`),!1):(this._currentLevel=e,!0))}getCurrentLevelConfig(){return this._levelConfigs.get(this._currentLevel)||null}isLevelUnlocked(e){if(1===e)return!0;const t=this._levelProgress.get(e-1);return!!t&&t.stars>=1}completeLevel(e,t){const i=this._levelConfigs.get(e);if(!i)return{stars:0,isNewRecord:!1,unlockedNext:!1};let n=0;t>=i.minScore&&(n=1),t>=i.mediumScore&&(n=2),t>=i.maxScore&&(n=3);let a=this._levelProgress.get(e);a||(a={level:e,completed:!1,stars:0,bestScore:0,attempts:0},this._levelProgress.set(e,a));const s=t>a.bestScore;a.completed=!0,a.attempts+=1,s&&(a.bestScore=t,a.stars=Math.max(a.stars,n));const o=e+1,r=this._levelConfigs.has(o)&&n>=1;return r&&!this._levelProgress.has(o)&&this._levelProgress.set(o,{level:o,completed:!1,stars:0,bestScore:0,attempts:0}),this.saveProgress(),console.log(`🏆 Level ${e} completed: ${n} stars, score: ${t}, new record: ${s}`),{stars:n,isNewRecord:s,unlockedNext:r}}getLevelProgress(e){return this._levelProgress.get(e)||null}getUnlockedLevels(){const e=[];for(const t of this._levelConfigs.keys())this.isLevelUnlocked(t)&&e.push(t);return e.sort(((e,t)=>e-t))}getTotalStars(){let e=0;for(const t of this._levelProgress.values())e+=t.stars;return e}getMaxStars(){return 3*this._levelConfigs.size}getBlockRarityForLevel(e){const t=this._levelConfigs.get(e);return t?t.maxBlockRarity:1}resetAllProgress(){this._levelProgress.clear(),this._currentLevel=1,localStorage.removeItem("blockPuzzle_levelProgress"),this.loadProgress(),console.log("🔄 All level progress reset")}}class h{_specialCells=new Map;setSpecialCell(e,t,i,n){const a=`${e},${t}`,o={type:i,state:s.FILLED,freezeLevel:"frozen"===i?n?.freezeLevel||2:void 0,bombRadius:"bomb"===i?n?.bombRadius||3:void 0};this._specialCells.set(a,o)}getSpecialCell(e,t){const i=`${e},${t}`;return this._specialCells.get(i)||null}removeSpecialCell(e,t){const i=`${e},${t}`;return this._specialCells.delete(i)}isSpecialCell(e,t){const i=`${e},${t}`;return this._specialCells.has(i)}processFrozenBlock(e,t){const i=this.getSpecialCell(e,t);return!(!i||"frozen"!==i.type||!i.freezeLevel)&&(i.freezeLevel--,i.freezeLevel<=0&&(this.removeSpecialCell(e,t),!0))}processBombExplosion(e,t,i,n){const a=this.getSpecialCell(e,t);if(a&&"bomb"===a.type){const s=a.bombRadius||3,o=[];for(let a=-Math.floor(s/2);a<=Math.floor(s/2);a++)for(let r=-Math.floor(s/2);r<=Math.floor(s/2);r++){const s=e+r,l=t+a;s>=0&&s<i&&l>=0&&l<n&&o.push({x:s,y:l})}return this.removeSpecialCell(e,t),o}return[]}isObstacle(e,t){const i=this.getSpecialCell(e,t);return"obstacle"===i?.type||!1}isRainbow(e,t){const i=this.getSpecialCell(e,t);return"rainbow"===i?.type||!1}getAllSpecialCells(){const e=[];for(const[t,i]of this._specialCells.entries()){const[n,a]=t.split(",").map(Number);e.push({x:n,y:a,cell:i})}return e}clearAll(){this._specialCells.clear()}generateLevelSpecialBlocks(e,t,i){if(this.clearAll(),e>=61){const n=Math.floor(e/20)+1,a=Math.floor(e/15)+1;for(let e=0;e<n;e++){const e=Math.floor(Math.random()*t),n=Math.floor(Math.random()*i);this.isSpecialCell(e,n)||this.setSpecialCell(e,n,"obstacle")}for(let e=0;e<a;e++){const e=Math.floor(Math.random()*t),n=Math.floor(Math.random()*i);this.isSpecialCell(e,n)||this.setSpecialCell(e,n,"frozen",{freezeLevel:2})}}if(e>=80&&Math.random()<.1){const e=Math.floor(Math.random()*t),n=Math.floor(Math.random()*i);this.isSpecialCell(e,n)||this.setSpecialCell(e,n,"rainbow")}}}class d{_config;_state;_startTime=0;_pausedTime=0;_onTimeUpdate;_onTimeWarning;_onTimeUp;_updateInterval;constructor(e){this._config=e,this._state={timeRemaining:e.timeLimit,totalTime:e.timeLimit,isActive:!1,isPaused:!1,finalScore:0,timeBonus:0}}start(){this._state.isActive||(this._state.isActive=!0,this._state.isPaused=!1,this._startTime=Date.now(),this._pausedTime=0,this.startTimer(),console.log(`⏰ Timed mode started: ${this._config.timeLimit}s`))}pause(){this._state.isActive&&!this._state.isPaused&&(this._state.isPaused=!0,this._pausedTime=Date.now(),this.stopTimer(),console.log("⏸️ Timed mode paused"))}resume(){if(!this._state.isActive||!this._state.isPaused)return;this._state.isPaused=!1;const e=Date.now()-this._pausedTime;this._startTime+=e,this.startTimer(),console.log("▶️ Timed mode resumed")}stop(){this._state.isActive&&(this._state.isActive=!1,this._state.isPaused=!1,this.stopTimer(),this.calculateFinalScore(),console.log(`🏁 Timed mode ended. Final score: ${this._state.finalScore}`))}startTimer(){this.stopTimer(),this._updateInterval=window.setInterval((()=>{this.updateTimer()}),100)}stopTimer(){this._updateInterval&&(clearInterval(this._updateInterval),this._updateInterval=void 0)}updateTimer(){if(!this._state.isActive||this._state.isPaused)return;const e=(Date.now()-this._startTime)/1e3;this._state.timeRemaining=Math.max(0,this._config.timeLimit-e),this._onTimeUpdate&&this._onTimeUpdate(this._state.timeRemaining),this._state.timeRemaining<=this._config.warningTime&&this._state.timeRemaining>0&&this._onTimeWarning&&this._onTimeWarning(this._state.timeRemaining),this._state.timeRemaining<=0&&(this.stop(),this._onTimeUp&&this._onTimeUp())}calculateFinalScore(){this._state.timeBonus=Math.floor(this._state.timeRemaining*this._config.timeBonus),this._state.finalScore=this._state.finalScore+this._state.timeBonus}addScore(e){const t=Math.floor(e*this._config.scoreMultiplier);return this._state.finalScore+=t,t}getFormattedTime(){const e=Math.floor(this._state.timeRemaining/60),t=Math.floor(this._state.timeRemaining%60);return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}getTimeProgress(){return(this._config.timeLimit-this._state.timeRemaining)/this._config.timeLimit}isWarningTime(){return this._state.timeRemaining<=this._config.warningTime&&this._state.timeRemaining>0}addBonusTime(e){this._config.timeLimit+=e,this._state.timeRemaining+=e,this._state.totalTime+=e,console.log(`⏰ Added ${e}s bonus time`)}setOnTimeUpdate(e){this._onTimeUpdate=e}setOnTimeWarning(e){this._onTimeWarning=e}setOnTimeUp(e){this._onTimeUp=e}get state(){return{...this._state}}get config(){return{...this._config}}get isActive(){return this._state.isActive}get isPaused(){return this._state.isPaused}get timeRemaining(){return this._state.timeRemaining}get finalScore(){return this._state.finalScore}destroy(){this.stopTimer(),this._state.isActive=!1}}const m={quick:{timeLimit:180,scoreMultiplier:1.5,timeBonus:10,warningTime:30},standard:{timeLimit:300,scoreMultiplier:1.2,timeBonus:8,warningTime:60},extended:{timeLimit:600,scoreMultiplier:1,timeBonus:5,warningTime:120}};class g{_currentChallenge=null;_results=new Map;constructor(){this.loadResults(),this.generateTodayChallenge()}loadResults(){try{const e=localStorage.getItem("blockPuzzle_dailyChallengeResults");if(e){const t=JSON.parse(e);for(const[e,i]of Object.entries(t))this._results.set(e,i)}}catch(e){console.warn("Failed to load daily challenge results:",e)}}saveResults(){try{const e={};for(const[t,i]of this._results.entries())e[t]=i;localStorage.setItem("blockPuzzle_dailyChallengeResults",JSON.stringify(e))}catch(e){console.warn("Failed to save daily challenge results:",e)}}generateTodayChallenge(){const e=this.getTodayString(),t=this.dateToSeed(e),i=this.seededRandom(t),n=[{type:"highScore",weight:3},{type:"timeAttack",weight:2},{type:"specialBlocks",weight:2},{type:"limitedMoves",weight:1}],a=n.reduce(((e,t)=>e+t.weight),0);let s=i()*a,o=n[0].type;for(const r of n)if(s-=r.weight,s<=0){o=r.type;break}this._currentChallenge=this.generateChallengeByType(e,t,o,i),console.log(`📅 Generated daily challenge for ${e}: ${this._currentChallenge.description}`)}generateChallengeByType(e,t,i,n){switch(i){case"highScore":return{date:e,seed:t,targetScore:2e3+Math.floor(3e3*n()),specialRules:["highScore"],description:"高分挑战 - 达到目标分数获得奖励"};case"timeAttack":return{date:e,seed:t,targetScore:1500+Math.floor(2e3*n()),timeLimit:300+Math.floor(300*n()),specialRules:["timeAttack"],description:"限时挑战 - 在规定时间内达到目标分数"};case"specialBlocks":return{date:e,seed:t,targetScore:1800+Math.floor(2200*n()),specialRules:["specialBlocks","obstacles"],description:"特殊方块挑战 - 游戏板包含障碍和特殊方块"};case"limitedMoves":return{date:e,seed:t,targetScore:1200+Math.floor(1800*n()),specialRules:["limitedMoves"],description:"限制步数挑战 - 用有限的方块达到目标分数"};default:return{date:e,seed:t,targetScore:2e3,specialRules:[],description:"每日标准挑战"}}}getTodayString(){return(new Date).toISOString().split("T")[0]}dateToSeed(e){let t=0;for(let i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return Math.abs(t)}seededRandom(e){let t=e;return()=>(t=(1664525*t+1013904223)%4294967296,t/4294967296)}getCurrentChallenge(){const e=this.getTodayString();return this._currentChallenge?.date!==e&&this.generateTodayChallenge(),this._currentChallenge}hasCompletedToday(){const e=this.getTodayString(),t=this._results.get(e);return t?.completed||!1}getTodayResult(){const e=this.getTodayString();return this._results.get(e)||null}submitResult(e,t){const i=this.getTodayString(),n=this.getCurrentChallenge();if(!n)throw new Error("No challenge available for today");let a=this._results.get(i);return a||(a={date:i,score:0,completed:!1,attempts:0},this._results.set(i,a)),a.attempts++,e>a.score&&(a.score=e,a.completed=e>=n.targetScore,void 0!==t&&(a.bestTime=t)),this.saveResults(),console.log(`📊 Daily challenge result submitted: ${e} points, completed: ${a.completed}`),a}getWeeklyResults(){const e=[],t=new Date;for(let i=6;i>=0;i--){const n=new Date(t);n.setDate(n.getDate()-i);const a=n.toISOString().split("T")[0],s=this._results.get(a);s?e.push(s):e.push({date:a,score:0,completed:!1,attempts:0})}return e}getStreak(){let e=0;const t=new Date;for(let i=0;i<30;i++){const n=new Date(t);n.setDate(n.getDate()-i);const a=n.toISOString().split("T")[0],s=this._results.get(a);if(!s?.completed)break;e++}return e}getTotalCompletedChallenges(){let e=0;for(const t of this._results.values())t.completed&&e++;return e}getSimulatedRanking(e){const t=Math.max(1,Math.floor((1e4-e)/100)),i=Math.floor(20*Math.random())-10;return Math.max(1,t+i)}resetAllData(){this._results.clear(),localStorage.removeItem("blockPuzzle_dailyChallengeResults"),this.generateTodayChallenge(),console.log("🔄 All daily challenge data reset")}}class u{_isInitialized=!1;_gameState=null;_blockGenerator;_effectManager=null;_levelManager;_specialBlockManager;_timedModeManager=null;_dailyChallengeManager;_lastClearTime=0;_currentGameMode=o.CLASSIC;_currentDifficulty=null;constructor(){this._blockGenerator=new l(1),this._levelManager=new c,this._specialBlockManager=new h,this._dailyChallengeManager=new g}init(){this._isInitialized=!0,this.initializeGame(),console.log("🔧 GameEngine initialized")}setEffectManager(e){this._effectManager=e}initializeGame(){let e=1;this._currentDifficulty&&(e=this._currentDifficulty.settings.startingLevel,this._levelManager.setCurrentLevel(e));const t=this._levelManager.getCurrentLevel(),i=this._levelManager.getCurrentLevelConfig();this._gameState={board:{width:10,height:10,grid:this.createEmptyGrid(10,10),score:0,level:t},candidateBlocks:this._blockGenerator.generateCandidateBlocks(3),selectedBlock:null,gameMode:this._currentGameMode,isGameOver:!1,isPaused:!1,combo:0,lastClearTime:0};let n=this._levelManager.getBlockRarityForLevel(t);if(this._currentDifficulty&&(n+=this._currentDifficulty.settings.blockComplexityBonus,n=Math.min(6,Math.max(1,n))),this._blockGenerator.setLevel(n),console.log(`🎮 Game initialized for level ${t} (block rarity: ${n})`),this._currentDifficulty&&console.log(`⚙️ Difficulty: ${this._currentDifficulty.name}`),i){const e=this.getAdjustedTargetScore(i.targetScore);console.log(`🎯 Target: ${e} points (original: ${i.targetScore})`)}}createEmptyGrid(e,t){const i=[];for(let n=0;n<t;n++){i[n]=[];for(let t=0;t<e;t++)i[n][t]=s.EMPTY}return i}canPlaceBlock(e,t,i){if(!this._gameState)return!1;const n=this._gameState.board,a=e.length,o=e[0].length;if(t<0||i<0||t+o>n.width||i+a>n.height)return!1;for(let r=0;r<a;r++)for(let a=0;a<o;a++)if(1===e[r][a]&&n.grid[i+r][t+a]!==s.EMPTY)return!1;return!0}placeBlock(e,t,i,n){if(!this._gameState||!this.canPlaceBlock(e,t,i))return!1;const a=this._gameState.board,o=e.length,r=e[0].length;for(let c=0;c<o;c++)for(let n=0;n<r;n++)1===e[c][n]&&(a.grid[i+c][t+n]=s.FILLED);const l=this._gameState.candidateBlocks.find((e=>e.id===n));if(this._gameState.candidateBlocks=this._gameState.candidateBlocks.filter((e=>e.id!==n)),this._effectManager&&l&&this._effectManager.playBlockPlaceEffect(t,i,e,l.shape.color),this.checkAndClearLines(),0===this._gameState.candidateBlocks.length){let e=this._levelManager.getBlockRarityForLevel(a.level);this._currentDifficulty&&(e+=this._currentDifficulty.settings.blockComplexityBonus,e=Math.min(6,Math.max(1,e))),this._blockGenerator.setLevel(e),this._gameState.candidateBlocks=this._blockGenerator.generateCandidateBlocks(3),console.log(`🔄 Generated new candidate blocks (block rarity: ${e})`)}return this.checkLevelCompletion(),this.checkGameOver(),!0}checkAndClearLines(){if(!this._gameState)return;const e=this._gameState.board,t=[],i=[];for(let n=0;n<e.height;n++){let i=!0;for(let t=0;t<e.width;t++)if(e.grid[n][t]===s.EMPTY){i=!1;break}i&&t.push(n)}for(let n=0;n<e.width;n++){let t=!0;for(let i=0;i<e.height;i++)if(e.grid[i][n]===s.EMPTY){t=!1;break}t&&i.push(n)}if(t.length>0||i.length>0){const n=Date.now();n-this._lastClearTime<3e3?this._gameState.combo++:this._gameState.combo=1,this._lastClearTime=n,t.forEach((t=>{for(let i=0;i<e.width;i++)e.grid[t][i]=s.EMPTY})),i.forEach((t=>{for(let i=0;i<e.height;i++)e.grid[i][t]=s.EMPTY}));const a=this.calculateClearScore(t.length,i.length),o=Math.min(this._gameState.combo,8),r=a*o;if(e.score+=r,console.log(`🎯 Cleared ${t.length} rows, ${i.length} cols`),console.log(`💥 Combo x${this._gameState.combo}, Score: ${a} x ${o} = +${r}`),this._effectManager){const e={rows:t,cols:i,score:r};this._effectManager.playClearEffect(e),this._gameState.combo>=2&&this._effectManager.playComboEffect(this._gameState.combo,175,300)}}else this._gameState.combo=0}calculateClearScore(e,t){let i=0;return i+=100*e+10*e*10,i+=100*t+10*t*10,(e>1||t>1)&&(i*=e+t),e>0&&t>0&&(i+=200),i}checkLevelCompletion(){if(!this._gameState)return;const e=this._gameState.board.level,t=this._levelManager.getCurrentLevelConfig();if(t){const i=this.getAdjustedTargetScore(t.targetScore);if(this._gameState.board.score>=i){const t=this._levelManager.completeLevel(e,this._gameState.board.score);console.log(`🏆 Level ${e} completed!`),console.log(`⭐ Stars: ${t.stars}, New Record: ${t.isNewRecord}`),t.unlockedNext&&console.log(`🔓 Level ${e+1} unlocked!`);const n=window.gameApp;if(n&&n.sceneManager&&this._gameState&&this._gameState.board){const a={level:e,score:this._gameState.board.score,targetScore:i,stars:t.stars,isNewRecord:t.isNewRecord,unlockedNext:t.unlockedNext,nextLevel:t.unlockedNext?e+1:void 0};n.sceneManager.showLevelComplete(a)}}}}nextLevel(){const e=this._levelManager.getCurrentLevel()+1;return!!this._levelManager.setCurrentLevel(e)&&(this.initializeGame(),!0)}restartLevel(){this.initializeGame()}switchGameMode(e,t){switch(this._currentGameMode=e,t?.difficulty&&(this._currentDifficulty=t.difficulty,this._currentDifficulty&&console.log(`⚙️ Difficulty set to: ${this._currentDifficulty.name}`)),this._timedModeManager&&(this._timedModeManager.destroy(),this._timedModeManager=null),e){case o.TIMED:if(t?.timeLimit){const e=180===t.timeLimit?"quick":300===t.timeLimit?"standard":"extended";let i=m[e];this._currentDifficulty&&(i={...i,timeLimit:Math.floor(i.timeLimit*this._currentDifficulty.settings.timeMultiplier)}),this._timedModeManager=new d(i)}break;case o.DAILY:const e=this._dailyChallengeManager.getCurrentChallenge();e&&console.log(`📅 Starting daily challenge: ${e.description}`)}this.initializeGame(),console.log(`🎮 Switched to ${e} mode`)}getAdjustedTargetScore(e){return this._currentDifficulty?Math.floor(e*this._currentDifficulty.settings.scoreMultiplier):e}get levelManager(){return this._levelManager}get specialBlockManager(){return this._specialBlockManager}get dailyChallengeManager(){return this._dailyChallengeManager}get timedModeManager(){return this._timedModeManager}get currentGameMode(){return this._currentGameMode}update(e){this._isInitialized&&this._gameState}destroy(){this._isInitialized=!1,this._gameState=null,console.log("🔧 GameEngine destroyed")}get gameState(){return this._gameState}get currentDifficulty(){return this._currentDifficulty}checkGameOver(){if(!this._gameState||this._gameState.isGameOver)return;this._gameState.candidateBlocks.some((e=>this.hasValidPlacementForBlock(e.shape.pattern)))||(this._gameState.isGameOver=!0,console.log("💀 Game Over! No valid placements for any candidate blocks"),this.showGameOverUI())}hasValidPlacementForBlock(e){if(!this._gameState)return!1;const t=this._gameState.board;for(let i=0;i<=t.height-e.length;i++)for(let n=0;n<=t.width-e[0].length;n++)if(this.canPlaceBlock(e,n,i))return!0;return!1}showGameOverUI(){const e=window.gameApp;if(e&&e.sceneManager&&this._gameState){const t={score:this._gameState.board.score,level:this._gameState.board.level,gameMode:this._gameState.gameMode,combo:this._gameState.combo};e.sceneManager.showGameOver(t)}}}class _{_stage;_callbacks;_isDragging=!1;_draggedBlock=null;_dragGraphics=null;_previewGraphics=null;_gameBoard=null;_cellSize=35;constructor(e,t={}){this._stage=e,this._callbacks=t,this.setupGlobalEvents()}setupGlobalEvents(){this._stage.interactive=!0,this._stage.on("pointermove",this.onGlobalPointerMove.bind(this)),this._stage.on("pointerup",this.onGlobalPointerUp.bind(this)),this._stage.on("pointerupoutside",this.onGlobalPointerUp.bind(this))}setGameBoard(e,t,i,n){this._gameBoard=e,this._cellSize=t}startDrag(t,i){this._isDragging||(this._isDragging=!0,this._draggedBlock=t,this._dragGraphics=this.createBlockGraphics(t,.8),this._dragGraphics.x=i.x,this._dragGraphics.y=i.y,this._stage.addChild(this._dragGraphics),this._previewGraphics=new e,this._gameBoard&&this._gameBoard.addChild(this._previewGraphics),this._callbacks.onDragStart&&this._callbacks.onDragStart(t),console.log(`🚀 Started dragging block: ${t.id}`))}onGlobalPointerMove(e){if(!this._isDragging||!this._dragGraphics||!this._draggedBlock)return;const t=e.data.global;this._dragGraphics.x=t.x-this._dragGraphics.width/2,this._dragGraphics.y=t.y-this._dragGraphics.height/2,this.updatePreview(t)}updatePreview(e){if(!this._previewGraphics||!this._draggedBlock||!this._gameBoard)return;const t=this._gameBoard.toLocal(e),i=Math.floor(t.x/this._cellSize),n=Math.floor(t.y/this._cellSize);if(this._previewGraphics.clear(),i<0||n<0||i>=10||n>=10)return;const a=this.canPlaceAt(i,n);this.drawPreview(i,n,a)}canPlaceAt(e,t){if(!this._draggedBlock)return!1;const i=this._draggedBlock.shape.pattern,n=i[0].length,a=i.length;return!(e<0||t<0||e+n>10||t+a>10)&&(!this._callbacks.canPlaceBlock||this._callbacks.canPlaceBlock(i,e,t))}drawPreview(e,t,i){if(!this._previewGraphics||!this._draggedBlock)return;const n=this._draggedBlock.shape.pattern,a=i?65280:16711680;this._previewGraphics.beginFill(a,.5),this._previewGraphics.lineStyle(1,a,.8);for(let s=0;s<n.length;s++)for(let i=0;i<n[0].length;i++)if(1===n[s][i]){const n=(e+i)*this._cellSize,a=(t+s)*this._cellSize;this._previewGraphics.drawRect(n+1,a+1,this._cellSize-2,this._cellSize-2)}this._previewGraphics.endFill()}onGlobalPointerUp(e){if(!this._isDragging||!this._draggedBlock)return;const t=e.data.global,i=this.tryPlaceBlock(t);this.endDrag(i)}tryPlaceBlock(e){if(!this._draggedBlock||!this._gameBoard)return!1;const t=this._gameBoard.toLocal(e),i=Math.floor(t.x/this._cellSize),n=Math.floor(t.y/this._cellSize);return!(i<0||n<0||i>=10||n>=10)&&(!!this._callbacks.onBlockPlaced&&this._callbacks.onBlockPlaced(this._draggedBlock,i,n))}endDrag(e){this._dragGraphics&&(this._stage.removeChild(this._dragGraphics),this._dragGraphics.destroy(),this._dragGraphics=null),this._previewGraphics&&(this._gameBoard&&this._gameBoard.removeChild(this._previewGraphics),this._previewGraphics.destroy(),this._previewGraphics=null),this._isDragging=!1,this._draggedBlock=null,this._callbacks.onDragEnd&&this._callbacks.onDragEnd(),console.log(`🎯 Drag ended, success: ${e}`)}createBlockGraphics(t,i=1){const n=new e,a=t.shape.pattern,s=parseInt(t.shape.color.replace("#",""),16),o=.8*this._cellSize;n.beginFill(s,i),n.lineStyle(1,16777215,.6);for(let e=0;e<a.length;e++)for(let t=0;t<a[0].length;t++)1===a[e][t]&&n.drawRect(t*o,e*o,o-1,o-1);return n.endFill(),n}destroy(){this.endDrag(!1),this._stage.off("pointermove",this.onGlobalPointerMove.bind(this)),this._stage.off("pointerup",this.onGlobalPointerUp.bind(this)),this._stage.off("pointerupoutside",this.onGlobalPointerUp.bind(this))}}class p{_container;_screenWidth;_screenHeight;_onModeSelected=null;_onBackToMain=null;_gameModes=[{mode:o.CLASSIC,title:"经典模式",description:"无限游戏，挑战最高分\n难度随分数递增",color:54527,icon:"♾️"},{mode:o.LEVEL,title:"关卡模式",description:"100个精心设计的关卡\n星级评定，解锁新关卡",color:3800852,icon:"🏆"},{mode:o.TIMED,title:"限时挑战",description:"3/5/10分钟竞速\n快速决策，刺激体验",color:16729156,icon:"⏰"},{mode:o.DAILY,title:"每日挑战",description:"每日独特关卡\n全球排行榜竞技",color:16755200,icon:"📅"}];constructor(e,i){this._container=new t,this._screenWidth=e,this._screenHeight=i,this.createUI()}createUI(){const t=new e;t.beginFill(657930,.95),t.drawRect(0,0,this._screenWidth,this._screenHeight),t.endFill(),t.interactive=!0,t.cursor="default",t.on("pointerdown",(e=>{e.stopPropagation(),e.preventDefault?.()})),t.on("pointerup",(e=>{e.stopPropagation(),e.preventDefault?.()})),t.on("pointermove",(e=>{e.stopPropagation(),e.preventDefault?.()})),this._container.addChild(t);const n=new i("第一步：选择游戏模式",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(48,this._screenWidth/20),fill:54527,align:"center"});n.anchor.set(.5),n.x=this._screenWidth/2,n.y=80,this._container.addChild(n);const a=new i("选择模式后将进入难度选择",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(16,this._screenWidth/60),fill:13421772,align:"center"});a.anchor.set(.5),a.x=this._screenWidth/2,a.y=120,this._container.addChild(a);const s=new i("步骤 1/2",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(18,this._screenWidth/55),fill:3800852,align:"center"});s.anchor.set(.5),s.x=this._screenWidth/2,s.y=145,this._container.addChild(s),this.createModeCards();const o=this.createButton("← 返回主界面",this._screenWidth/2,this._screenHeight-60,(()=>{this.hide(),this.triggerBackToMain()}));this._container.addChild(o)}createModeCards(){const e=Math.min(280,this._screenWidth/2-40),t=Math.min(200,this._screenHeight/4),i=this._screenWidth>800?2:1,n=Math.ceil(this._gameModes.length/i),a=i*e+20*(i-1),s=n*t+20*(n-1),o=(this._screenWidth-a)/2,r=(this._screenHeight-s)/2+40;this._gameModes.forEach(((n,a)=>{const s=a%i,l=Math.floor(a/i),c=o+s*(e+20),h=r+l*(t+20),d=this.createModeCard(n,c,h,e,t);this._container.addChild(d)}))}createModeCard(n,a,s,r,l){const c=new t;c.x=a,c.y=s;const h=new e;h.beginFill(1710618,.9),h.lineStyle(3,n.color,.8),h.drawRoundedRect(0,0,r,l,15),h.endFill(),c.addChild(h);const d=new i(n.icon,{fontFamily:"Arial",fontSize:Math.min(48,r/6),fill:n.color,align:"center"});d.anchor.set(.5),d.x=r/2,d.y=50,c.addChild(d);const m=new i(n.title,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(24,r/12),fill:16777215,align:"center"});m.anchor.set(.5),m.x=r/2,m.y=100,c.addChild(m);const g=new i(n.description,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(14,r/20),fill:13421772,align:"center",wordWrap:!0,wordWrapWidth:r-20});return g.anchor.set(.5),g.x=r/2,g.y=140,c.addChild(g),c.interactive=!0,c.cursor="pointer",c.on("pointerdown",(()=>{n.mode===o.TIMED?this.showTimerOptions(n.mode):this._onModeSelected&&this._onModeSelected(n.mode)})),c.on("pointerover",(()=>{h.tint=14540253,c.scale.set(1.05)})),c.on("pointerout",(()=>{h.tint=16777215,c.scale.set(1)})),c}showTimerOptions(n){const a=new t,s=new e;s.beginFill(0,.8),s.drawRect(0,0,this._screenWidth,this._screenHeight),s.endFill(),s.interactive=!0,s.cursor="default",s.on("pointerdown",(e=>{e.stopPropagation(),e.preventDefault?.()})),s.on("pointerup",(e=>{e.stopPropagation(),e.preventDefault?.()})),a.addChild(s);const o=Math.min(400,this._screenWidth-40),r=Math.min(300,this._screenHeight-40),l=new e;l.beginFill(1710618,.95),l.lineStyle(2,16729156,.8),l.drawRoundedRect(0,0,o,r,20),l.endFill(),l.x=(this._screenWidth-o)/2,l.y=(this._screenHeight-r)/2,a.addChild(l);const c=new i("选择时间限制",{fontFamily:"JetBrains Mono, monospace",fontSize:24,fill:16729156,align:"center"});c.anchor.set(.5),c.x=o/2,c.y=50,l.addChild(c);[{time:180,label:"3分钟 - 快速挑战"},{time:300,label:"5分钟 - 标准挑战"},{time:600,label:"10分钟 - 深度挑战"}].forEach(((e,t)=>{const i=this.createTimeButton(e.label,o/2,100+50*t,(()=>{this._onModeSelected&&this._onModeSelected(n,{timeLimit:e.time}),this._container.removeChild(a),a.destroy()}));l.addChild(i)}));const h=this.createTimeButton("取消",o/2,250,(()=>{this._container.removeChild(a),a.destroy()}));l.addChild(h),this._container.addChild(a)}createTimeButton(n,a,s,o){const r=new t;r.x=a,r.y=s;const l=new e;l.beginFill(16729156,.8),l.lineStyle(2,16777215,.8),l.drawRoundedRect(-150,-15,300,30,15),l.endFill(),r.addChild(l);const c=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:16777215,align:"center"});return c.anchor.set(.5),r.addChild(c),r.interactive=!0,r.cursor="pointer",r.on("pointerdown",o),r.on("pointerover",(()=>{l.tint=14540253})),r.on("pointerout",(()=>{l.tint=16777215})),r}createButton(n,a,s,o){const r=new t;r.x=a,r.y=s;const l=new e;l.beginFill(6710886,.8),l.lineStyle(2,16777215,.8),l.drawRoundedRect(-80,-20,160,40,20),l.endFill(),r.addChild(l);const c=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:16777215,align:"center"});return c.anchor.set(.5),r.addChild(c),r.interactive=!0,r.cursor="pointer",r.on("pointerdown",o),r.on("pointerover",(()=>{l.tint=14540253})),r.on("pointerout",(()=>{l.tint=16777215})),r}setOnModeSelected(e){this._onModeSelected=e}setOnBackToMain(e){this._onBackToMain=e}triggerBackToMain(){this._onBackToMain&&this._onBackToMain()}show(){this._container.visible=!0}hide(){this._container.visible=!1}get container(){return this._container}destroy(){this._container.destroy()}}class f{_container;_screenWidth;_screenHeight;_onNextLevel;_onRestart;_onMainMenu;constructor(e,i){this._container=new t,this._screenWidth=e,this._screenHeight=i,this._container.visible=!1}show(e){this.createUI(e),this._container.visible=!0}hide(){this._container.visible=!1,this._container.removeChildren()}createUI(t){this._container.removeChildren();const n=new e;n.beginFill(0,.8),n.drawRect(0,0,this._screenWidth,this._screenHeight),n.endFill(),n.interactive=!0,n.cursor="default",n.on("pointerdown",(e=>{e.stopPropagation(),e.preventDefault?.()})),n.on("pointerup",(e=>{e.stopPropagation(),e.preventDefault?.()})),n.on("pointermove",(e=>{e.stopPropagation(),e.preventDefault?.()})),this._container.addChild(n);const a=Math.min(400,this._screenWidth-40),s=Math.min(500,this._screenHeight-40),o=new e;o.beginFill(1710618,.95),o.lineStyle(3,54527,.8),o.drawRoundedRect(0,0,a,s,20),o.endFill(),o.x=(this._screenWidth-a)/2,o.y=(this._screenHeight-s)/2,this._container.addChild(o);let r=40;const l=new i("关卡完成！",{fontFamily:"JetBrains Mono, monospace",fontSize:32,fill:54527,align:"center"});l.anchor.set(.5,0),l.x=a/2,l.y=r,o.addChild(l),r+=60;const c=new i(`第 ${t.level} 关`,{fontFamily:"JetBrains Mono, monospace",fontSize:24,fill:16777215,align:"center"});c.anchor.set(.5,0),c.x=a/2,c.y=r,o.addChild(c),r+=40;const h="⭐".repeat(t.stars)+"☆".repeat(3-t.stars),d=new i(h,{fontFamily:"Arial",fontSize:36,fill:16776960,align:"center"});d.anchor.set(.5,0),d.x=a/2,d.y=r,o.addChild(d),r+=60;const m=new i(`得分: ${t.score}`,{fontFamily:"JetBrains Mono, monospace",fontSize:20,fill:3800852,align:"center"});m.anchor.set(.5,0),m.x=a/2,m.y=r,o.addChild(m),r+=30;const g=new i(`目标: ${t.targetScore}`,{fontFamily:"JetBrains Mono, monospace",fontSize:18,fill:13421772,align:"center"});if(g.anchor.set(.5,0),g.x=a/2,g.y=r,o.addChild(g),r+=40,t.isNewRecord){const e=new i("🎉 新记录！",{fontFamily:"JetBrains Mono, monospace",fontSize:18,fill:16729156,align:"center"});e.anchor.set(.5,0),e.x=a/2,e.y=r,o.addChild(e),r+=30}if(t.unlockedNext&&t.nextLevel){const e=new i(`🔓 解锁第 ${t.nextLevel} 关`,{fontFamily:"JetBrains Mono, monospace",fontSize:18,fill:54527,align:"center"});e.anchor.set(.5,0),e.x=a/2,e.y=r,o.addChild(e),r+=40}const u=s-100;if(t.unlockedNext&&t.nextLevel){const e=this.createButton("下一关",a/2-80,u,3800852,(()=>{this._onNextLevel&&this._onNextLevel(),this.hide()}));o.addChild(e);const t=this.createButton("重新开始",a/2+80,u,16746496,(()=>{this._onRestart&&this._onRestart(),this.hide()}));o.addChild(t)}else{const e=this.createButton("重新开始",a/2,u,16746496,(()=>{this._onRestart&&this._onRestart(),this.hide()}));o.addChild(e)}const _=this.createButton("主菜单",a/2,u+50,6710886,(()=>{this._onMainMenu&&this._onMainMenu(),this.hide()}));o.addChild(_)}createButton(n,a,s,o,r){const l=new t;l.x=a,l.y=s;const c=new e;c.beginFill(o,.8),c.lineStyle(2,16777215,.8),c.drawRoundedRect(-60,-20,120,40,20),c.endFill(),l.addChild(c);const h=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:16777215,align:"center"});return h.anchor.set(.5),l.addChild(h),l.interactive=!0,l.cursor="pointer",l.on("pointerdown",r),l.on("pointerover",(()=>{c.tint=14540253,l.scale.set(1.05)})),l.on("pointerout",(()=>{c.tint=16777215,l.scale.set(1)})),l}setOnNextLevel(e){this._onNextLevel=e}setOnRestart(e){this._onRestart=e}setOnMainMenu(e){this._onMainMenu=e}get container(){return this._container}destroy(){this._container.destroy()}}class y{_container;_screenWidth;_screenHeight;_onRestart;_onMainMenu;constructor(e,i){this._container=new t,this._screenWidth=e,this._screenHeight=i,this._container.visible=!1}show(e){this.createUI(e),this._container.visible=!0}hide(){this._container.visible=!1}get container(){return this._container}setOnRestart(e){this._onRestart=e}setOnMainMenu(e){this._onMainMenu=e}createUI(t){this._container.removeChildren();const n=new e;n.beginFill(0,.8),n.drawRect(0,0,this._screenWidth,this._screenHeight),n.endFill(),n.interactive=!0,n.cursor="default",n.on("pointerdown",(e=>{e.stopPropagation(),e.preventDefault?.()})),n.on("pointerup",(e=>{e.stopPropagation(),e.preventDefault?.()})),n.on("pointermove",(e=>{e.stopPropagation(),e.preventDefault?.()})),this._container.addChild(n);const a=Math.min(450,this._screenWidth-40),s=Math.min(550,this._screenHeight-40),r=new e;r.beginFill(1710618,.95),r.lineStyle(3,16729156,.8),r.drawRoundedRect(0,0,a,s,20),r.endFill(),r.x=(this._screenWidth-a)/2,r.y=(this._screenHeight-s)/2,this._container.addChild(r);let l=40;const c=new i("💀 游戏结束",{fontFamily:"JetBrains Mono, monospace",fontSize:36,fill:16729156,align:"center"});c.anchor.set(.5,0),c.x=a/2,c.y=l,r.addChild(c),l+=70;const h=this.getGameModeText(t.gameMode),d=new i(`游戏模式: ${h}`,{fontFamily:"JetBrains Mono, monospace",fontSize:20,fill:54527,align:"center"});if(d.anchor.set(.5,0),d.x=a/2,d.y=l,r.addChild(d),l+=40,t.gameMode===o.LEVEL){const e=new i(`关卡: ${t.level}`,{fontFamily:"JetBrains Mono, monospace",fontSize:18,fill:13421772,align:"center"});e.anchor.set(.5,0),e.x=a/2,e.y=l,r.addChild(e),l+=35}const m=new i(`最终分数: ${t.score.toLocaleString()}`,{fontFamily:"JetBrains Mono, monospace",fontSize:28,fill:3800852,align:"center"});if(m.anchor.set(.5,0),m.x=a/2,m.y=l,r.addChild(m),l+=50,t.combo>1){const e=new i(`最高连击: ${t.combo}x`,{fontFamily:"JetBrains Mono, monospace",fontSize:20,fill:16755200,align:"center"});e.anchor.set(.5,0),e.x=a/2,e.y=l,r.addChild(e),l+=40}const g=new e;g.lineStyle(2,6710886,.5),g.moveTo(50,l+20),g.lineTo(a-50,l+20),r.addChild(g),l+=50;const u=new i("无法放置任何候选方块",{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:13421772,align:"center"});u.anchor.set(.5,0),u.x=a/2,u.y=l,r.addChild(u),l+=40;const _=s-120,p=this.createButton("🔄 重新开始",a/2,_,3800852,(()=>{this._onRestart&&this._onRestart(),this.hide()}));r.addChild(p);const f=this.createButton("🏠 返回主菜单",a/2,_+60,6710886,(()=>{this._onMainMenu&&this._onMainMenu(),this.hide()}));r.addChild(f)}getGameModeText(e){switch(e){case o.CLASSIC:return"经典模式 ♾️";case o.LEVEL:return"关卡模式 🏆";case o.TIMED:return"限时挑战 ⏰";case o.DAILY:return"每日挑战 📅";default:return"未知模式"}}createButton(n,a,s,o,r){const l=new t;l.x=a,l.y=s;const c=new e;c.beginFill(o,.8),c.lineStyle(2,16777215,.8),c.drawRoundedRect(-100,-20,200,40,20),c.endFill(),l.addChild(c);const h=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:16777215,align:"center"});return h.anchor.set(.5),l.addChild(h),l.interactive=!0,l.cursor="pointer",l.on("pointerdown",r),l.on("pointerover",(()=>{c.tint=14540253,l.scale.set(1.05)})),l.on("pointerout",(()=>{c.tint=16777215,l.scale.set(1)})),l}}class M{_container;_screenWidth;_screenHeight;_onDifficultySelected=null;_onBackToModeSelect=null;_difficulties=[{id:"easy",name:"简单",description:"适合新手\n• 简单方块为主\n• 较低分数要求\n• 充裕时间限制",color:3800852,icon:"🌱",settings:{startingLevel:1,scoreMultiplier:.7,blockComplexityBonus:-1,timeMultiplier:1.5}},{id:"normal",name:"普通",description:"标准难度\n• 平衡的方块分布\n• 标准分数要求\n• 正常时间限制",color:54527,icon:"⚖️",settings:{startingLevel:1,scoreMultiplier:1,blockComplexityBonus:0,timeMultiplier:1}},{id:"hard",name:"困难",description:"挑战性强\n• 更多复杂方块\n• 更高分数要求\n• 时间压力大",color:16746496,icon:"🔥",settings:{startingLevel:10,scoreMultiplier:1.3,blockComplexityBonus:2,timeMultiplier:.8}},{id:"expert",name:"专家",description:"极限挑战\n• 大量复杂方块\n• 极高分数要求\n• 极限时间压力",color:16729156,icon:"💀",settings:{startingLevel:30,scoreMultiplier:1.8,blockComplexityBonus:3,timeMultiplier:.6}},{id:"nightmare",name:"噩梦",description:"只适合大师\n• 巨型方块挑战\n• 恐怖分数要求\n• 分秒必争",color:8388863,icon:"👹",settings:{startingLevel:60,scoreMultiplier:2.5,blockComplexityBonus:4,timeMultiplier:.4}}];constructor(e,i){this._container=new t,this._screenWidth=e,this._screenHeight=i,this._container.visible=!1,this.createUI()}createUI(){const t=new e;t.beginFill(0,.9),t.drawRect(0,0,this._screenWidth,this._screenHeight),t.endFill(),t.interactive=!0,t.cursor="default",t.on("pointerdown",(e=>{e.stopPropagation(),e.preventDefault?.()})),t.on("pointerup",(e=>{e.stopPropagation(),e.preventDefault?.()})),t.on("pointermove",(e=>{e.stopPropagation(),e.preventDefault?.()})),this._container.addChild(t);const n=new i("第二步：选择游戏难度",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(42,this._screenWidth/24),fill:54527,align:"center"});n.anchor.set(.5),n.x=this._screenWidth/2,n.y=80,this._container.addChild(n);const a=new i("选择难度后将开始游戏 • 难度影响方块复杂度、分数要求和时间限制",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(16,this._screenWidth/60),fill:13421772,align:"center"});a.anchor.set(.5),a.x=this._screenWidth/2,a.y=120,this._container.addChild(a);const s=new i("步骤 2/2 - 最后一步！",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(18,this._screenWidth/55),fill:3800852,align:"center"});s.anchor.set(.5),s.x=this._screenWidth/2,s.y=145,this._container.addChild(s),this.createDifficultyCards();const o=this.createButton("← 返回模式选择",this._screenWidth/2,this._screenHeight-60,6710886,(()=>{this.hide(),this._onBackToModeSelect&&this._onBackToModeSelect()}));this._container.addChild(o)}createDifficultyCards(){const e=Math.min(200,this._screenWidth/6),t=Math.min(280,this._screenHeight/3),i=this._difficulties.length*e+15*(this._difficulties.length-1),n=(this._screenWidth-i)/2,a=(this._screenHeight-t)/2+20;this._difficulties.forEach(((i,s)=>{const o=n+s*(e+15),r=a,l=this.createDifficultyCard(i,o,r,e,t);this._container.addChild(l)}))}createDifficultyCard(n,a,s,o,r){const l=new t;l.x=a,l.y=s;const c=new e;c.beginFill(1710618,.95),c.lineStyle(3,n.color,.8),c.drawRoundedRect(0,0,o,r,12),c.endFill(),l.addChild(c);const h=new i(n.icon,{fontFamily:"Arial",fontSize:Math.min(36,o/5),fill:n.color,align:"center"});h.anchor.set(.5),h.x=o/2,h.y=40,l.addChild(h);const d=new i(n.name,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(20,o/10),fill:n.color,align:"center",fontWeight:"bold"});d.anchor.set(.5),d.x=o/2,d.y=80,l.addChild(d);const m=new i(n.description,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(12,o/16),fill:13421772,align:"center",wordWrap:!0,wordWrapWidth:o-16});m.anchor.set(.5),m.x=o/2,m.y=150,l.addChild(m);const g=n.settings,u=new i(`起始: ${g.startingLevel}关\n分数: x${g.scoreMultiplier}\n时间: x${g.timeMultiplier}`,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(10,o/20),fill:11184810,align:"center"});return u.anchor.set(.5),u.x=o/2,u.y=r-40,l.addChild(u),l.interactive=!0,l.cursor="pointer",l.on("pointerdown",(()=>{this._onDifficultySelected&&this._onDifficultySelected(n)})),l.on("pointerover",(()=>{if(c.tint=14540253,l.scale.set(1.05),"nightmare"===n.id){let e=0;const t=()=>{e+=.1;const i=2*Math.sin(20*e),n=1*Math.cos(25*e);l.x=a+i,l.y=s+n,l.parent&&e<1?requestAnimationFrame(t):(l.x=a,l.y=s)};t()}})),l.on("pointerout",(()=>{c.tint=16777215,l.scale.set(1),l.x=a,l.y=s})),l}createButton(n,a,s,o,r){const l=new t;l.x=a,l.y=s;const c=new e;c.beginFill(o,.8),c.lineStyle(2,16777215,.8),c.drawRoundedRect(-60,-20,120,40,20),c.endFill(),l.addChild(c);const h=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:16,fill:16777215,align:"center"});return h.anchor.set(.5),l.addChild(h),l.interactive=!0,l.cursor="pointer",l.on("pointerdown",r),l.on("pointerover",(()=>{c.tint=14540253,l.scale.set(1.05)})),l.on("pointerout",(()=>{c.tint=16777215,l.scale.set(1)})),l}setOnDifficultySelected(e){this._onDifficultySelected=e}setOnBackToModeSelect(e){this._onBackToModeSelect=e}show(){this._container.visible=!0}hide(){this._container.visible=!1}get container(){return this._container}destroy(){this._container.destroy()}}class S{_stage=null;_isInitialized=!1;_currentScene=null;_screenWidth=1024;_screenHeight=768;_currentSceneType="welcome";_gameState=null;_gameBoard=null;_candidateArea=null;_scoreText=null;_dragManager=null;_gameModeSelectUI=null;_levelCompleteUI=null;_gameOverUI=null;_difficultySelectUI=null;_onBlockPlacedCallback=null;_canPlaceBlockCallback=null;_onModeSelectedCallback=null;_selectedGameMode=null;_selectedModeOptions=null;_mobileLayoutConfig=null;init(e,t=1024,i=768,n){this._stage=e,this._screenWidth=t,this._screenHeight=i,this._mobileLayoutConfig=n||null,this._isInitialized=!0,this.createWelcomeScene(),console.log(`🎬 SceneManager initialized for ${t}x${i}`)}updateMobileLayout(e){this._mobileLayoutConfig=e,"game"===this._currentSceneType?this.createGameScene():"welcome"===this._currentSceneType&&this.createWelcomeScene()}createWelcomeScene(){if(!this._stage)return;const n=new t,a=new e;a.beginFill(657930),a.drawRect(0,0,this._screenWidth,this._screenHeight),a.endFill(),a.interactive=!1,a.interactiveChildren=!1,n.addChild(a),this.createAnimatedBackground(n);const s=this._screenWidth/2,o=this._screenHeight/2,r=new t;r.x=s,r.y=Math.max(120,.18*this._screenHeight),n.addChild(r);const l=Math.min(52,this._screenWidth/18),c=new i("BLOCK PUZZLE",{fontFamily:"JetBrains Mono, monospace",fontSize:l,fill:54527,align:"center",fontWeight:"bold"});c.anchor.set(.5),c.y=-20,r.addChild(c);const h=new i("CLASSIC",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(32,.6*l),fill:3800852,align:"center",fontWeight:"bold"});h.anchor.set(.5),h.y=c.y+l+5,r.addChild(h);const d=new i("🧩 方块拼图经典版 🎮",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(20,this._screenWidth/45),fill:13421772,align:"center"});d.anchor.set(.5),d.y=h.y+40,r.addChild(d);const m=new i("游戏流程：选择模式 → 选择难度 → 开始游戏",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(14,this._screenWidth/70),fill:3800852,align:"center"});m.anchor.set(.5),m.y=d.y+35,r.addChild(m),this.createCurrentSettingsDisplay(r,m.y+25),this.animateLogo(r);const g=Math.min(320,.3*this._screenWidth),u=Math.min(640,.6*this._screenHeight),_=new e;_.lineStyle(2,54527,1),_.beginFill(1710618,.8),_.drawRect(0,0,g,u),_.endFill(),_.x=s-g/2,_.y=o-u/2+50,n.addChild(_);const p=Math.min(32,g/10);this.drawGrid(_,g,u,p);const f=this.createEnhancedButton("🚀 开始游戏",s,Math.min(this._screenHeight-100,_.y+u+30),54527,(()=>{this.showGameModeSelect()}));n.addChild(f);const y=Math.min(16,this._screenWidth/60),M=new i("请先选择游戏模式和难度，然后开始游戏",{fontFamily:"JetBrains Mono, monospace",fontSize:y,fill:13421772,align:"center"});M.anchor.set(.5),M.x=s,M.y=Math.min(this._screenHeight-50,_.y+u+60),n.addChild(M),this._currentScene=n,this._stage.addChild(n)}createAnimatedBackground(t){const i=Math.min(30,this._screenWidth/40);for(let n=0;n<i;n++){const i=new e,n=2+3*Math.random(),a=360*Math.random(),s=this.hslToHex(a,70,50);i.beginFill(s,.3+.4*Math.random()),i.drawCircle(0,0,n),i.endFill(),i.x=Math.random()*this._screenWidth,i.y=Math.random()*this._screenHeight,t.addChild(i),this.animateBackgroundParticle(i,a)}}animateBackgroundParticle(e,t){let i=Math.random()*Math.PI*2,n=.3+.7*Math.random();const a=()=>{i+=.02,e.x+=Math.sin(i)*n,e.y+=Math.cos(.7*i)*n*.5+.2,e.x>this._screenWidth+20&&(e.x=-20),e.x<-20&&(e.x=this._screenWidth+20),e.y>this._screenHeight+20&&(e.y=-20);const s=(t+20*i)%360,o=this.hslToHex(s,70,50);e.tint=o,e.alpha=.3+.2*Math.sin(3*i),requestAnimationFrame(a)};a()}animateLogo(e){let t=0;const i=()=>{t+=.02,e.y+=.5*Math.sin(t);const n=1+.02*Math.sin(1.5*t);e.scale.set(n),requestAnimationFrame(i)};i()}hslToHex(e,t,i){i/=100;const n=t*Math.min(i,1-i)/100,a=t=>{const a=(t+e/30)%12,s=i-n*Math.max(Math.min(a-3,9-a,1),-1);return Math.round(255*s)};return a(0)<<16|a(8)<<8|a(4)}startGame(){"welcome"===this._currentSceneType&&(console.log("🎬 Switching to game scene..."),this._currentSceneType="game",this.createGameScene())}createGameScene(){if(!this._stage)return;this._currentScene&&this._stage.removeChild(this._currentScene);const n=new t,a=new e;a.beginFill(657930),a.drawRect(0,0,this._screenWidth,this._screenHeight),a.endFill(),a.interactive=!1,a.interactiveChildren=!1,n.addChild(a);const s=this._screenWidth/2,o=this._mobileLayoutConfig,r=o?o.fontSize:{small:16,medium:18,large:24},l=o?o.spacing:{small:10,medium:15,large:20},c=l.medium,h=new i("Level: 1",{fontFamily:"JetBrains Mono, monospace",fontSize:r.medium,fill:3800852,align:"center"});h.anchor.set(.5,0),h.x=s-100,h.y=c,n.addChild(h),this._scoreText=new i("Score: 0 / 50",{fontFamily:"JetBrains Mono, monospace",fontSize:r.medium,fill:54527,align:"center"}),this._scoreText.anchor.set(.5,0),this._scoreText.x=s+100,this._scoreText.y=c,n.addChild(this._scoreText);const d=c+r.medium+2*l.large;let m,g,u;this.createGameModeDisplay(n,s,d),o?(m=o.cellSize,g=o.boardSize,u=o.boardSize):(m=Math.min(35,Math.min(this._screenWidth,this._screenHeight)/20),g=10*m,u=10*m);const _=d+50+l.medium;if(this._gameBoard=new e,this._gameBoard.x=s-g/2,this._gameBoard.y=_,this.drawGameBoard(this._gameBoard,g,u,m),n.addChild(this._gameBoard),this._candidateArea=new t,o&&"column"===o.candidateArea.direction?(this._candidateArea.x=this._gameBoard.x+g+l.medium,this._candidateArea.y=this._gameBoard.y):(this._candidateArea.x=s,this._candidateArea.y=this._gameBoard.y+u+3*l.large),this.createCandidateArea(this._candidateArea,m),n.addChild(this._candidateArea),!o||!this._mobileLayoutConfig){const e=new i("Drag blocks from bottom to place them",{fontFamily:"JetBrains Mono, monospace",fontSize:r.small,fill:13421772,align:"center"});e.anchor.set(.5),e.x=s,e.y=this._screenHeight-l.large,n.addChild(e)}this._currentScene=n,this._stage.addChild(n),this.initializeDragManager(m);const p=window.gameApp;p&&p.effectManager&&p.effectManager.setGameBoard(this._gameBoard,m,this._gameBoard.x,this._gameBoard.y),this.updateGameDisplay()}resize(e,t){this._screenWidth=e,this._screenHeight=t,this._currentScene&&this._stage&&(this._stage.removeChild(this._currentScene),this._currentScene=null),"welcome"===this._currentSceneType?this.createWelcomeScene():"game"===this._currentSceneType&&this.createGameScene(),console.log(`🔄 Scene resized to ${e}x${t}`)}drawGrid(e,t,i,n){const a=Math.floor(t/n),s=Math.floor(i/n);e.lineStyle(1,3355443,.5);for(let o=0;o<=a;o++)e.moveTo(o*n,0),e.lineTo(o*n,i);for(let o=0;o<=s;o++)e.moveTo(0,o*n),e.lineTo(t,o*n)}update(e){this._isInitialized}destroy(){this._currentScene&&this._stage&&this._stage.removeChild(this._currentScene),this._stage=null,this._isInitialized=!1,this._currentScene=null,console.log("🎬 SceneManager destroyed")}setGameState(e){this._gameState=e,"game"===this._currentSceneType&&this.updateGameDisplay()}setBlockPlacedCallback(e){this._onBlockPlacedCallback=e}setCanPlaceBlockCallback(e){this._canPlaceBlockCallback=e}setOnModeSelectedCallback(e){this._onModeSelectedCallback=e}showLevelComplete(e){this._stage&&(this._levelCompleteUI||(this._levelCompleteUI=new f(this._screenWidth,this._screenHeight),this._levelCompleteUI.setOnNextLevel((()=>{const e=window.gameApp;if(e&&e.gameEngine){e.gameEngine.nextLevel();const t=e.gameEngine.gameState;t&&this.setGameState(t)}})),this._levelCompleteUI.setOnRestart((()=>{const e=window.gameApp;if(e&&e.gameEngine){e.gameEngine.restartLevel();const t=e.gameEngine.gameState;t&&this.setGameState(t)}})),this._levelCompleteUI.setOnMainMenu((()=>{this._currentSceneType="welcome",this.createWelcomeScene()})),this._stage.addChild(this._levelCompleteUI.container)),this._levelCompleteUI.show(e))}showGameOver(e){this._stage&&(this._gameOverUI||(this._gameOverUI=new y(this._screenWidth,this._screenHeight),this._gameOverUI.setOnRestart((()=>{const e=window.gameApp;if(e&&e.gameEngine){e.gameEngine.restartLevel();const t=e.gameEngine.gameState;t&&this.setGameState(t)}})),this._gameOverUI.setOnMainMenu((()=>{this._currentSceneType="welcome",this.createWelcomeScene()})),this._stage.addChild(this._gameOverUI.container)),this._gameOverUI.show(e))}createEnhancedButton(n,a,s,o,r){const l=new t;l.x=a,l.y=s;const c=new e;c.beginFill(o,.2),c.drawRoundedRect(-85,-25,170,50,25),c.endFill(),l.addChild(c);const h=new e;h.beginFill(o,.8),h.lineStyle(3,16777215,.9),h.drawRoundedRect(-80,-20,160,40,20),h.endFill(),l.addChild(h);const d=new e;d.beginFill(16777215,.1),d.drawRoundedRect(-75,-18,150,15,15),d.endFill(),l.addChild(d);const m=new i(n,{fontFamily:"JetBrains Mono, monospace",fontSize:18,fill:16777215,align:"center",fontWeight:"bold"});m.anchor.set(.5),l.addChild(m),l.interactive=!0,l.cursor="pointer";let g=0;const u=()=>{g+=.05,c.alpha=.2+.1*Math.sin(g),requestAnimationFrame(u)};return u(),l.on("pointerdown",(()=>{l.scale.set(.95),setTimeout((()=>{l.scale.set(1),r()}),100)})),l.on("pointerover",(()=>{h.tint=14540253,l.scale.set(1.05),c.alpha=.4})),l.on("pointerout",(()=>{h.tint=16777215,l.scale.set(1),c.alpha=.2})),l}showGameModeSelect(){this._stage&&(this._gameModeSelectUI||(this._gameModeSelectUI=new p(this._screenWidth,this._screenHeight),this._gameModeSelectUI.setOnModeSelected(((e,t)=>{this._selectedGameMode=e,this._selectedModeOptions=t,this._gameModeSelectUI?.hide(),this.showDifficultySelect()})),this._gameModeSelectUI.setOnBackToMain((()=>{this._gameModeSelectUI?.hide(),this._currentSceneType="welcome",this.createWelcomeScene()})),this._stage.addChild(this._gameModeSelectUI.container)),this._gameModeSelectUI.show())}showDifficultySelect(){this._stage&&(this._difficultySelectUI||(this._difficultySelectUI=new M(this._screenWidth,this._screenHeight),this._difficultySelectUI.setOnDifficultySelected((e=>{if(this._difficultySelectUI?.hide(),this._selectedGameMode&&this._onModeSelectedCallback){const t={...this._selectedModeOptions,difficulty:e};this._onModeSelectedCallback(this._selectedGameMode,t)}this.startGame()})),this._difficultySelectUI.setOnBackToModeSelect((()=>{this._difficultySelectUI?.hide(),this._gameModeSelectUI?.show()})),this._stage.addChild(this._difficultySelectUI.container)),this._difficultySelectUI.show())}drawGameBoard(e,t,i,n){e.clear(),e.beginFill(1710618,.9),e.lineStyle(2,54527,1),e.drawRect(0,0,t,i),e.endFill(),e.lineStyle(1,3355443,.5);for(let a=0;a<=10;a++)e.moveTo(a*n,0),e.lineTo(a*n,i);for(let a=0;a<=10;a++)e.moveTo(0,a*n),e.lineTo(t,a*n)}createCandidateArea(t,n){t.removeChildren();const a=this._mobileLayoutConfig,s=a?a.fontSize:{small:16,medium:18,large:24},o=a?a.spacing:{small:10,medium:15,large:20},r=new i("候选方块",{fontFamily:"JetBrains Mono, monospace",fontSize:s.medium,fill:3800852,align:"center"});r.anchor.set(.5);const l=3*n;if(a&&"column"===a.candidateArea.direction){r.x=0,r.y=-o.large-s.medium/2,t.addChild(r);for(let i=0;i<3;i++){const n=i*(l+o.medium),a=new e;a.lineStyle(1,6710886,.8),a.beginFill(2763306,.5),a.drawRect(-l/2,n,l,l),a.endFill(),t.addChild(a)}}else{r.x=0,r.y=-o.large-s.medium/2,t.addChild(r);for(let i=0;i<3;i++){const n=(i-1)*(l+o.medium),a=new e;a.lineStyle(1,6710886,.8),a.beginFill(2763306,.5),a.drawRect(n-l/2,0,l,l),a.endFill(),t.addChild(a)}}}updateGameDisplay(){if(!(this._gameState&&this._gameBoard&&this._candidateArea&&this._scoreText))return;const e=this._gameState.board.level,t=this._gameState.board.score,n=window.gameApp;if(n&&n.gameEngine){const a=n.gameEngine.levelManager.getCurrentLevelConfig();if(a){this._scoreText.text=`Score: ${t} / ${a.targetScore}`;const n=this._scoreText.parent.children.find((e=>e instanceof i&&e.text.startsWith("Level:")));n&&(n.text=`Level: ${e}`)}else this._scoreText.text=`Score: ${t}`}else this._scoreText.text=`Score: ${t}`;const a=this._mobileLayoutConfig;let s;s=a?a.cellSize:Math.min(35,Math.min(this._screenWidth,this._screenHeight)/20);const o=10*s,r=10*s;this.drawGameBoard(this._gameBoard,o,r,s),this.drawPlacedBlocks(this._gameBoard,s),this.updateCandidateBlocks(this._candidateArea,s)}drawPlacedBlocks(e,t){if(!this._gameState)return;const i=this._gameState.board;for(let n=0;n<i.height;n++)for(let a=0;a<i.width;a++)1===i.grid[n][a]&&(e.beginFill(54527,.8),e.drawRect(a*t+1,n*t+1,t-2,t-2),e.endFill())}updateCandidateBlocks(e,t){if(!this._gameState)return;e.children.filter((e=>"candidateBlock"===e.name)).forEach((t=>e.removeChild(t)));const i=this._mobileLayoutConfig,n=i?i.spacing:{small:10,medium:15,large:20},a=3*t;this._gameState.candidateBlocks.forEach(((s,o)=>{if(o<3){let r,l;i&&"column"===i.candidateArea.direction?(r=0,l=o*(a+n.medium)+a/2):(r=(o-1)*(a+n.medium),l=a/2),this.drawCandidateBlock(e,s,r,l,t)}}))}initializeDragManager(e){if(!this._stage)return;const t={onBlockPlaced:(e,t,i)=>{if(this._onBlockPlacedCallback){const n=this._onBlockPlacedCallback(e,t,i);return n&&this.updateGameDisplay(),n}return!1},canPlaceBlock:(e,t,i)=>!this._canPlaceBlockCallback||this._canPlaceBlockCallback(e,t,i),onDragStart:e=>{console.log(`🚀 Started dragging: ${e.shape.name}`)},onDragEnd:()=>{console.log("🎯 Drag ended")}};this._dragManager=new _(this._stage,t),this._gameBoard&&this._dragManager.setGameBoard(this._gameBoard,e,this._gameBoard.x,this._gameBoard.y)}drawCandidateBlock(i,a,s,o,r){const l=new t;l.name="candidateBlock",l.x=s,l.y=o;const c=a.shape.pattern,h=c[0].length,d=c.length,m=.6*r,g=-(h*m)/2,u=-(d*m)/2,_=new e;for(let e=0;e<d;e++)for(let t=0;t<h;t++)if(1===c[e][t]){const i=parseInt(a.shape.color.replace("#",""),16);_.beginFill(i,.9),_.lineStyle(1,16777215,.3),_.drawRect(g+t*m,u+e*m,m-1,m-1),_.endFill()}l.addChild(_),l.interactive=!0,l.cursor="pointer",l.on("pointerdown",(e=>{if(console.log(`🎯 Starting drag for block: ${a.id}`),this._dragManager){const t=e.data.global;this._dragManager.startDrag(a,new n(t.x,t.y))}})),i.addChild(l)}createCurrentSettingsDisplay(n,a){const s=window.gameApp;let r="未选择",l="未选择",c=6710886,h=6710886,d=!1;if(this._selectedGameMode)switch(this._selectedGameMode){case o.CLASSIC:r="经典模式 ♾️",c=54527;break;case o.LEVEL:r="关卡模式 🏆",c=3800852;break;case o.TIMED:const e=this._selectedModeOptions?.timeLimit;r=`限时挑战 ⏰ (${e?e/60+"分钟":"未设置"})`,c=16729156;break;case o.DAILY:r="每日挑战 📅",c=16755200}if(s?.gameEngine?.currentDifficulty){const e=s.gameEngine.currentDifficulty;l=`${e.icon} ${e.name}`,h=e.color}d=null!==this._selectedGameMode&&null!==s?.gameEngine?.currentDifficulty;const m=new t;m.y=a;const g=d?1718810:1710618,u=d?3800852:3355443,_=new e;_.beginFill(g,.7),_.lineStyle(1,u,.8),_.drawRoundedRect(-180,-35,360,70,10),_.endFill(),m.addChild(_);const p=new i(d?"✅ 设置完成":"⚙️ 当前设置",{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(14,this._screenWidth/70),fill:d?3800852:13421772,align:"center"});p.anchor.set(.5),p.y=-25,m.addChild(p);const f=new i(`模式: ${r}`,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(12,this._screenWidth/80),fill:c,align:"center"});f.anchor.set(.5),f.y=-8,m.addChild(f);const y=new i(`难度: ${l}`,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(12,this._screenWidth/80),fill:h,align:"center"});y.anchor.set(.5),y.y=8,m.addChild(y),n.addChild(m)}createGameModeDisplay(n,a,s){const r=window.gameApp;let l="未选择",c="未选择",h=6710886,d=6710886;if(this._selectedGameMode)switch(this._selectedGameMode){case o.CLASSIC:l="经典模式 ♾️",h=54527;break;case o.LEVEL:l="关卡模式 🏆",h=3800852;break;case o.TIMED:const e=this._selectedModeOptions?.timeLimit;l=`限时挑战 ⏰ (${e?e/60+"分钟":"未设置"})`,h=16729156;break;case o.DAILY:l="每日挑战 📅",h=16755200}if(r?.gameEngine?.currentDifficulty){const e=r.gameEngine.currentDifficulty;c=`${e.icon} ${e.name}`,d=e.color}const m=new t;m.x=a,m.y=s;const g=new e;g.beginFill(1710618,.7),g.lineStyle(1,3355443,.8),g.drawRoundedRect(-180,-20,360,40,8),g.endFill(),m.addChild(g);const u=new i(`模式: ${l}`,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(11,this._screenWidth/85),fill:h,align:"center"});u.anchor.set(.5),u.x=-90,u.y=0,m.addChild(u);const _=new i(`难度: ${c}`,{fontFamily:"JetBrains Mono, monospace",fontSize:Math.min(11,this._screenWidth/85),fill:d,align:"center"});_.anchor.set(.5),_.x=90,_.y=0,m.addChild(_),n.addChild(m)}}class v{_canvas=null;_isInitialized=!1;_keys=new Set;_audioManager=null;_callbacks={};init(e,t,i){this._canvas=e,this._audioManager=t||null,this._callbacks=i||{},this._isInitialized=!0,this.setupEventListeners(),console.log("🎮 InputManager initialized")}setupEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),this._canvas&&(this._canvas.addEventListener("click",this.handleClick.bind(this)),this._canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)))}handleKeyDown(e){switch(this._keys.add(e.code),this._audioManager&&this._audioManager.playClickSound(),e.code){case"Space":e.preventDefault(),console.log("🚀 Space key pressed - Game should start!"),this._callbacks.onSpacePressed&&this._callbacks.onSpacePressed();break;case"Escape":console.log("⏸️ Escape key pressed - Game should pause!"),this._callbacks.onEscapePressed&&this._callbacks.onEscapePressed()}}handleKeyUp(e){this._keys.delete(e.code)}handleClick(e){if(!this._canvas)return;const t=this._canvas.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this._audioManager&&this._audioManager.playClickSound(),console.log(`🖱️ Click at (${i}, ${n})`),this._callbacks.onCanvasClick&&this._callbacks.onCanvasClick(i,n)}handleMouseMove(e){if(!this._canvas)return;const t=this._canvas.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this._callbacks.onMouseMove&&this._callbacks.onMouseMove(i,n)}update(){this._isInitialized}isKeyPressed(e){return this._keys.has(e)}destroy(){document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this)),this._canvas&&(this._canvas.removeEventListener("click",this.handleClick.bind(this)),this._canvas.removeEventListener("mousemove",this.handleMouseMove.bind(this))),this._canvas=null,this._audioManager=null,this._isInitialized=!1,this._keys.clear(),console.log("🎮 InputManager destroyed")}}class w{_isInitialized=!1;_audioContext=null;_isUserInteracted=!1;async init(){try{this._isInitialized=!0,this.setupUserInteractionListener(),console.log("🔊 AudioManager initialized (waiting for user interaction)")}catch(e){console.warn("⚠️ AudioManager failed to initialize:",e)}}setupUserInteractionListener(){const e=async()=>{if(!this._isUserInteracted)try{this._audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===this._audioContext.state&&await this._audioContext.resume(),this._isUserInteracted=!0,console.log("🔊 AudioContext created after user interaction"),document.removeEventListener("click",e),document.removeEventListener("keydown",e),document.removeEventListener("touchstart",e)}catch(t){console.warn("⚠️ Failed to create AudioContext:",t)}};document.addEventListener("click",e,{once:!0}),document.addEventListener("keydown",e,{once:!0}),document.addEventListener("touchstart",e,{once:!0})}playClickSound(){if(this._isInitialized&&this._audioContext&&this._isUserInteracted)try{const e=this._audioContext.createOscillator(),t=this._audioContext.createGain();e.connect(t),t.connect(this._audioContext.destination),e.frequency.setValueAtTime(800,this._audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(400,this._audioContext.currentTime+.1),t.gain.setValueAtTime(.1,this._audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this._audioContext.currentTime+.1),e.start(this._audioContext.currentTime),e.stop(this._audioContext.currentTime+.1)}catch(e){console.warn("⚠️ Failed to play click sound:",e)}else console.log("🔇 Audio not ready yet, skipping click sound")}playSuccessSound(){if(this._isInitialized&&this._audioContext&&this._isUserInteracted)try{const e=this._audioContext.createOscillator(),t=this._audioContext.createGain();e.connect(t),t.connect(this._audioContext.destination),e.frequency.setValueAtTime(400,this._audioContext.currentTime),e.frequency.exponentialRampToValueAtTime(800,this._audioContext.currentTime+.2),t.gain.setValueAtTime(.15,this._audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this._audioContext.currentTime+.2),e.start(this._audioContext.currentTime),e.stop(this._audioContext.currentTime+.2)}catch(e){console.warn("⚠️ Failed to play success sound:",e)}else console.log("🔇 Audio not ready yet, skipping success sound")}get isAudioReady(){return this._isInitialized&&null!==this._audioContext&&this._isUserInteracted}destroy(){this._audioContext&&(this._audioContext.close(),this._audioContext=null),this._isInitialized=!1,this._isUserInteracted=!1,console.log("🔊 AudioManager destroyed")}}class C{_stage;_effectLayer;_gameBoard=null;_cellSize=35;constructor(e){this._stage=e,this._effectLayer=new t,this._effectLayer.name="effectLayer",this._stage.addChild(this._effectLayer)}setGameBoard(e,t,i,n){this._gameBoard=e,this._cellSize=t}playClearEffect(e){console.log(`🎆 Playing clear effect: ${e.rows.length} rows, ${e.cols.length} cols, +${e.score} points`);const t=e.rows.length+e.cols.length;t>=3?this.playRainbowWaveEffect(e.rows,e.cols):2===t?(this.playShakeEffect(),this.playEnhancedFlashEffect(e.rows,e.cols)):this.playStandardClearEffect(e.rows,e.cols),setTimeout((()=>{this.playScorePopAnimation(e.score)}),200),t>=2&&setTimeout((()=>{this.playComboLineEffect(e.rows,e.cols)}),300)}playRowClearAnimation(t){if(!this._gameBoard)return;const i=new e;i.beginFill(16777215,.8),i.drawRect(0,t*this._cellSize,10*this._cellSize,this._cellSize),i.endFill(),this._gameBoard.addChild(i);let n=.8;const a=()=>{n-=.1,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard?.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createParticleExplosion(5*this._cellSize,t*this._cellSize+this._cellSize/2,54527)}playColClearAnimation(t){if(!this._gameBoard)return;const i=new e;i.beginFill(16777215,.8),i.drawRect(t*this._cellSize,0,this._cellSize,10*this._cellSize),i.endFill(),this._gameBoard.addChild(i);let n=.8;const a=()=>{n-=.1,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard?.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createParticleExplosion(t*this._cellSize+this._cellSize/2,5*this._cellSize,3800852)}createParticleExplosion(t,i,n){if(!this._gameBoard)return;for(let a=0;a<12;a++){const s=new e;s.beginFill(n),s.drawRect(0,0,4,4),s.endFill(),s.x=t,s.y=i;const o=a/12*Math.PI*2,r=2+3*Math.random(),l=Math.cos(o)*r,c=Math.sin(o)*r;this._gameBoard.addChild(s);let h=1;const d=()=>{s.x+=l,s.y+=c,h-=.05,s.alpha=h,h>0?requestAnimationFrame(d):(this._gameBoard?.removeChild(s),s.destroy())};requestAnimationFrame(d)}}playScorePopAnimation(e){if(!this._gameBoard)return;const t=new i(`+${e}`,{fontFamily:"JetBrains Mono, monospace",fontSize:24,fill:16776960,stroke:0,strokeThickness:2});t.anchor.set(.5),t.x=5*this._cellSize,t.y=5*this._cellSize,this._gameBoard.addChild(t);let n=0;const a=()=>{n+=.016,t.y-=2,t.alpha=1-n/1.5,t.scale.set(1+.5*n),n<1.5?requestAnimationFrame(a):(this._gameBoard?.removeChild(t),t.destroy())};requestAnimationFrame(a)}playBlockPlaceEffect(t,i,n,a){if(!this._gameBoard)return;const s=parseInt(a.replace("#",""),16);for(let o=0;o<n.length;o++)for(let a=0;a<n[0].length;a++)if(1===n[o][a]){const n=(t+a)*this._cellSize,r=(i+o)*this._cellSize,l=new e;l.beginFill(s,.9),l.lineStyle(2,16777215,.8),l.drawRect(n+1,r+1,this._cellSize-2,this._cellSize-2),l.endFill(),this._gameBoard.addChild(l);let c=0;const h=()=>{c+=.016;const e=1+.1*Math.sin(20*c)*(1-c/.3);l.scale.set(e),c<.3?requestAnimationFrame(h):(this._gameBoard?.removeChild(l),l.destroy())};setTimeout((()=>{requestAnimationFrame(h)}),50*(a+o))}}playComboEffect(e,t,n){if(e<2)return;const a=new i(`COMBO x${e}!`,{fontFamily:"JetBrains Mono, monospace",fontSize:32,fill:16711935,stroke:16777215,strokeThickness:3});a.anchor.set(.5),a.x=t,a.y=n-50,this._effectLayer.addChild(a);let s=0;const o=()=>{s+=.016;const e=1+.2*Math.sin(10*s);a.scale.set(e);const t=360*s%360;a.tint=this.hslToHex(t,100,50),s>1.5&&(a.alpha=1-(s-1.5)/.5),s<2?requestAnimationFrame(o):(this._effectLayer.removeChild(a),a.destroy())};requestAnimationFrame(o)}hslToHex(e,t,i){i/=100;const n=t*Math.min(i,1-i)/100,a=t=>{const a=(t+e/30)%12,s=i-n*Math.max(Math.min(a-3,9-a,1),-1);return Math.round(255*s)};return a(0)<<16|a(8)<<8|a(4)}playStandardClearEffect(e,t){e.forEach(((e,t)=>{setTimeout((()=>{this.playRowClearAnimation(e)}),100*t)})),t.forEach(((e,t)=>{setTimeout((()=>{this.playColClearAnimation(e)}),100*t+50)}))}playEnhancedFlashEffect(e,t){this._gameBoard&&(e.forEach(((e,t)=>{setTimeout((()=>{this.playEnhancedRowFlash(e)}),80*t)})),t.forEach(((e,t)=>{setTimeout((()=>{this.playEnhancedColFlash(e)}),80*t+40)})))}playEnhancedRowFlash(t){if(!this._gameBoard)return;const i=new e;i.beginFill(16777215,.9),i.drawRect(0,t*this._cellSize,10*this._cellSize,this._cellSize),i.endFill(),this._gameBoard.addChild(i),setTimeout((()=>{if(!this._gameBoard)return;const i=new e;i.beginFill(65535,.7),i.drawRect(0,t*this._cellSize,10*this._cellSize,this._cellSize),i.endFill(),this._gameBoard.addChild(i);let n=.7;const a=()=>{n-=.05,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard&&this._gameBoard.removeChild(i),i.destroy())};requestAnimationFrame(a)}),100);let n=.9;const a=()=>{n-=.1,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard&&this._gameBoard.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createEnhancedParticleExplosion(5*this._cellSize,t*this._cellSize+this._cellSize/2,65535,20)}playEnhancedColFlash(t){if(!this._gameBoard)return;const i=new e;i.beginFill(16777215,.9),i.drawRect(t*this._cellSize,0,this._cellSize,10*this._cellSize),i.endFill(),this._gameBoard.addChild(i),setTimeout((()=>{if(!this._gameBoard)return;const i=new e;i.beginFill(16711935,.7),i.drawRect(t*this._cellSize,0,this._cellSize,10*this._cellSize),i.endFill(),this._gameBoard.addChild(i);let n=.7;const a=()=>{n-=.05,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard&&this._gameBoard.removeChild(i),i.destroy())};requestAnimationFrame(a)}),100);let n=.9;const a=()=>{n-=.1,i.alpha=n,n>0?requestAnimationFrame(a):(this._gameBoard&&this._gameBoard.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createEnhancedParticleExplosion(t*this._cellSize+this._cellSize/2,5*this._cellSize,16711935,20)}playRainbowWaveEffect(e,t){if(!this._gameBoard)return;const i=5*this._cellSize,n=5*this._cellSize;for(let a=0;a<3;a++)setTimeout((()=>{this.createRainbowWave(i,n,a)}),200*a);e.forEach(((e,t)=>{setTimeout((()=>{this.playRainbowRowFlash(e)}),50*t)})),t.forEach(((e,t)=>{setTimeout((()=>{this.playRainbowColFlash(e)}),50*t+100)}))}createRainbowWave(t,i,n){if(!this._gameBoard)return;const a=new e;this._gameBoard.addChild(a);let s=0,o=0;const r=8*this._cellSize,l=()=>{o+=.05,s+=3,a.clear();const e=(180*o+120*n)%360,c=this.hslToHex(e,100,50);a.lineStyle(4,c,1-s/r),a.drawCircle(t,i,s),s<r?requestAnimationFrame(l):(this._gameBoard?.removeChild(a),a.destroy())};requestAnimationFrame(l)}playRainbowRowFlash(t){if(!this._gameBoard)return;const i=new e;this._gameBoard.addChild(i);let n=0;const a=()=>{n+=.033,i.clear();const e=360*n%360,s=this.hslToHex(e,100,60),o=.8*(1-n/1);i.beginFill(s,o),i.drawRect(0,t*this._cellSize,10*this._cellSize,this._cellSize),i.endFill(),n<1?requestAnimationFrame(a):(this._gameBoard?.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createRainbowParticleExplosion(5*this._cellSize,t*this._cellSize+this._cellSize/2)}playRainbowColFlash(t){if(!this._gameBoard)return;const i=new e;this._gameBoard.addChild(i);let n=0;const a=()=>{n+=.033,i.clear();const e=(360*n+180)%360,s=this.hslToHex(e,100,60),o=.8*(1-n/1);i.beginFill(s,o),i.drawRect(t*this._cellSize,0,this._cellSize,10*this._cellSize),i.endFill(),n<1?requestAnimationFrame(a):(this._gameBoard?.removeChild(i),i.destroy())};requestAnimationFrame(a),this.createRainbowParticleExplosion(t*this._cellSize+this._cellSize/2,5*this._cellSize)}playShakeEffect(){if(!this._gameBoard)return;const e=this._gameBoard.x,t=this._gameBoard.y;let i=0;const n=()=>{if(i+=.016,i<.3){const a=3*(Math.random()-.5)*(1-i/.3),s=3*(Math.random()-.5)*(1-i/.3);this._gameBoard&&(this._gameBoard.x=e+a,this._gameBoard.y=t+s),requestAnimationFrame(n)}else this._gameBoard&&(this._gameBoard.x=e,this._gameBoard.y=t)};requestAnimationFrame(n)}playComboLineEffect(e,t){this._gameBoard&&e.forEach((e=>{t.forEach((t=>{this.createComboLine(t*this._cellSize+this._cellSize/2,e*this._cellSize+this._cellSize/2,5*this._cellSize,5*this._cellSize)}))}))}createComboLine(t,i,n,a){if(!this._gameBoard)return;const s=new e;this._gameBoard.addChild(s);let o=0,r=0;const l=()=>{r+=.033,o=Math.min(1,r/.5),s.clear();const e=540*r%360,c=this.hslToHex(e,100,50);s.lineStyle(3,c,1-o),s.moveTo(t,i);const h=t+(n-t)*o,d=i+(a-i)*o;s.lineTo(h,d),o<1?requestAnimationFrame(l):(this._gameBoard?.removeChild(s),s.destroy())};requestAnimationFrame(l)}createEnhancedParticleExplosion(t,i,n,a=20){if(this._gameBoard)for(let s=0;s<a;s++){const o=new e;o.beginFill(n),Math.random()>.5?o.drawRect(0,0,3,3):o.drawCircle(0,0,2),o.endFill(),o.x=t,o.y=i;const r=s/a*Math.PI*2+.5*Math.random(),l=2+4*Math.random(),c=Math.cos(r)*l,h=Math.sin(r)*l;this._gameBoard.addChild(o);let d=1,m=1;const g=()=>{o.x+=c,o.y+=h,d-=.03,m=d,o.alpha=d,o.scale.set(m),d>0?requestAnimationFrame(g):(this._gameBoard?.removeChild(o),o.destroy())};requestAnimationFrame(g)}}createRainbowParticleExplosion(t,i){if(!this._gameBoard)return;for(let n=0;n<25;n++){const a=new e,s=n/25*360,o=this.hslToHex(s,100,60);a.beginFill(o),a.drawCircle(0,0,2+2*Math.random()),a.endFill(),a.x=t,a.y=i;const r=n/25*Math.PI*2,l=3+5*Math.random(),c=Math.cos(r)*l,h=Math.sin(r)*l;this._gameBoard.addChild(a);let d=1,m=0;const g=()=>{m+=.033,a.x+=c,a.y+=h,d-=.02;const e=(s+360*m)%360,t=this.hslToHex(e,100,60);a.tint=t,a.alpha=d,a.scale.set(d),d>0?requestAnimationFrame(g):(this._gameBoard?.removeChild(a),a.destroy())};requestAnimationFrame(g)}}destroy(){this._effectLayer.parent&&this._effectLayer.parent.removeChild(this._effectLayer),this._effectLayer.destroy()}}class b{static instance;deviceInfo;layoutConfig;constructor(){this.deviceInfo=this.detectDevice(),this.layoutConfig=this.calculateLayout(),this.setupEventListeners()}static getInstance(){return b.instance||(b.instance=new b),b.instance}detectDevice(){const e=window.innerWidth,t=window.innerHeight,i=window.devicePixelRatio||1,n=e<=480||this.isMobileUserAgent(),a=!n&&e<=768;return{isMobile:n,isTablet:a,isDesktop:!n&&!a,isPortrait:t>e,isLandscape:e>t,screenWidth:e,screenHeight:t,devicePixelRatio:i,safeAreaInsets:this.getSafeAreaInsets()}}isMobileUserAgent(){const e=navigator.userAgent.toLowerCase();return/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e)}getSafeAreaInsets(){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: env(safe-area-inset-top);\n      right: env(safe-area-inset-right);\n      bottom: env(safe-area-inset-bottom);\n      left: env(safe-area-inset-left);\n      visibility: hidden;\n      pointer-events: none;\n    ",document.body.appendChild(e);const t=getComputedStyle(e),i={top:parseInt(t.top)||0,right:parseInt(t.right)||0,bottom:parseInt(t.bottom)||0,left:parseInt(t.left)||0};return document.body.removeChild(e),i}calculateLayout(){const{isMobile:e,isTablet:t,isPortrait:i,screenWidth:n,screenHeight:a,safeAreaInsets:s}=this.deviceInfo,o=n-s.left-s.right,r=a-s.top-s.bottom;let l;if(e)if(i){const e=Math.min(o-20,.6*r);l={cellSize:Math.floor(e/10),boardSize:e,fontSize:{small:10,medium:12,large:16},spacing:{small:4,medium:8,large:12},candidateArea:{width:o,height:.25*r,direction:"row"}}}else{const e=Math.min(r-20,.6*o);l={cellSize:Math.floor(e/10),boardSize:e,fontSize:{small:9,medium:11,large:14},spacing:{small:3,medium:6,large:9},candidateArea:{width:.3*o,height:r,direction:"column"}}}else if(t){const e=Math.min(.7*o,.7*r);l={cellSize:Math.floor(e/10),boardSize:e,fontSize:{small:14,medium:16,large:20},spacing:{small:8,medium:12,large:16},candidateArea:{width:o,height:.2*r,direction:"row"}}}else l={cellSize:35,boardSize:350,fontSize:{small:16,medium:18,large:24},spacing:{small:10,medium:15,large:20},candidateArea:{width:600,height:150,direction:"row"}};return l}setupEventListeners(){window.addEventListener("orientationchange",(()=>{setTimeout((()=>{this.deviceInfo=this.detectDevice(),this.layoutConfig=this.calculateLayout(),this.notifyLayoutChange()}),100)})),window.addEventListener("resize",(()=>{this.deviceInfo=this.detectDevice(),this.layoutConfig=this.calculateLayout(),this.notifyLayoutChange()})),document.addEventListener("fullscreenchange",(()=>{setTimeout((()=>{this.deviceInfo=this.detectDevice(),this.layoutConfig=this.calculateLayout(),this.notifyLayoutChange()}),100)}))}notifyLayoutChange(){const e=new CustomEvent("mobileLayoutChange",{detail:{deviceInfo:this.deviceInfo,layoutConfig:this.layoutConfig}});window.dispatchEvent(e)}getDeviceInfo(){return{...this.deviceInfo}}getLayoutConfig(){return{...this.layoutConfig}}isMobile(){return this.deviceInfo.isMobile}isTablet(){return this.deviceInfo.isTablet}isDesktop(){return this.deviceInfo.isDesktop}isPortrait(){return this.deviceInfo.isPortrait}isLandscape(){return this.deviceInfo.isLandscape}getFontSize(e){return this.layoutConfig.fontSize[e]}getSpacing(e){return this.layoutConfig.spacing[e]}getBoardConfig(){return{cellSize:this.layoutConfig.cellSize,boardSize:this.layoutConfig.boardSize}}getCandidateAreaConfig(){return{...this.layoutConfig.candidateArea}}optimizeTouchEvents(){let e=0;document.addEventListener("touchend",(t=>{const i=Date.now();i-e<=300&&t.preventDefault(),e=i}),{passive:!1}),document.addEventListener("contextmenu",(e=>{e.preventDefault()})),document.addEventListener("touchmove",(e=>{e.preventDefault()}),{passive:!1})}requestFullscreen(){const e=document.documentElement;return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():Promise.reject(new Error("Fullscreen not supported"))}exitFullscreen(){return document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():Promise.reject(new Error("Exit fullscreen not supported"))}getRendererConfig(){const{isMobile:e,devicePixelRatio:t}=this.deviceInfo;return{antialias:!e,powerPreference:e?"low-power":"high-performance",resolution:Math.min(t,e?1:2),preserveDrawingBuffer:!1,clearBeforeRender:!0,backgroundColor:657930}}}const B=b.getInstance(),k=()=>{const e=B.getDeviceInfo();return console.log("📱 Device detected: "+(e.isMobile?"Mobile":e.isTablet?"Tablet":"Desktop")),console.log(`📐 Screen size: ${e.screenWidth}x${e.screenHeight}`),console.log("🔄 Orientation: "+(e.isPortrait?"Portrait":"Landscape")),{width:e.screenWidth,height:e.screenHeight}},x=k(),z=B.getRendererConfig(),L={width:x.width,height:x.height,backgroundColor:657930,hello:!1,...z},F=new class{app;gameEngine;sceneManager;inputManager;audioManager;effectManager;mobileAdapter;screenWidth;screenHeight;gameStarted=!1;constructor(e){console.log("GameApp constructor start"),this.mobileAdapter=b.getInstance(),this.mobileAdapter.optimizeTouchEvents();const t=this.mobileAdapter.getDeviceInfo(),i=this.mobileAdapter.getRendererConfig(),n={width:t.screenWidth,height:t.screenHeight,...i,...e};this.app=new a(n),this.screenWidth=n.width,this.screenHeight=n.height,this.gameEngine=new u,this.sceneManager=new S,this.inputManager=new v,this.audioManager=new w,this.effectManager=new C(this.app.stage),this.setupMobileLayoutListener(),console.log(`📱 Game app initialized for ${this.mobileAdapter.isMobile()?"mobile":this.mobileAdapter.isTablet()?"tablet":"desktop"} device`),console.log("GameApp constructor end")}async init(e){try{const t=document.getElementById("app");if(t){t.innerHTML="";const i=e||this.app.view;t.appendChild(i),this.optimizeForMobile(i)}await this.initializeManagers(),this.startGameLoop(),console.log("✅ Game initialized successfully")}catch(t){throw console.error("❌ Failed to initialize game:",t),t}}optimizeForMobile(e){e.style.width="100%",e.style.height="100%",e.style.display="block",e.style.touchAction="none",this.mobileAdapter.isMobile()&&(e.style.imageRendering="pixelated",e.style.webkitUserSelect="none",e.style.userSelect="none",this.updateViewportMeta())}updateViewportMeta(){let e=document.querySelector('meta[name="viewport"]');e||(e=document.createElement("meta"),e.setAttribute("name","viewport"),document.head.appendChild(e));const t=["width=device-width","initial-scale=1.0","maximum-scale=1.0","minimum-scale=1.0","user-scalable=no","viewport-fit=cover"].join(", ");e.setAttribute("content",t)}setupMobileLayoutListener(){window.addEventListener("mobileLayoutChange",(e=>{const{deviceInfo:t,layoutConfig:i}=e.detail;console.log("📱 Mobile layout changed:",t),this.resize(t.screenWidth,t.screenHeight),this.sceneManager.updateMobileLayout(i)}))}async initializeManagers(){console.log("initializeManagers start"),await this.audioManager.init(),console.log("initializeManagers audioManager end");const e={onSpacePressed:()=>this.handleSpacePressed(),onEscapePressed:()=>this.handleEscapePressed(),onCanvasClick:(e,t)=>this.handleCanvasClick(e,t),onMouseMove:(e,t)=>this.handleMouseMove(e,t)};this.inputManager.init(this.app.view,this.audioManager,e),console.log("initializeManagers inputManager end");const t=this.mobileAdapter.getLayoutConfig();this.sceneManager.init(this.app.stage,this.screenWidth,this.screenHeight,t),console.log("initializeManagers sceneManager end"),this.gameEngine.init(),this.gameEngine.setEffectManager(this.effectManager),this.setupSceneManagerCallbacks(),console.log("initializeManagers end")}setupSceneManagerCallbacks(){this.sceneManager.setBlockPlacedCallback(((e,t,i)=>{console.log(`🎯 Attempting to place block ${e.id} at (${t}, ${i})`);const n=this.gameEngine.placeBlock(e.shape.pattern,t,i,e.id);if(n){console.log("✅ Block placed successfully!"),this.audioManager.isAudioReady&&this.audioManager.playSuccessSound();const e=this.gameEngine.gameState;e&&this.sceneManager.setGameState(e)}else console.log("❌ Cannot place block at this position"),this.audioManager.isAudioReady&&this.audioManager.playClickSound();return n})),this.sceneManager.setCanPlaceBlockCallback(((e,t,i)=>this.gameEngine.canPlaceBlock(e,t,i))),this.sceneManager.setOnModeSelectedCallback(((e,t)=>{console.log(`🎮 Mode selected: ${e}`,t),this.gameEngine.switchGameMode(e,t),this.gameStarted=!0;const i=this.gameEngine.gameState;i&&(this.sceneManager.setGameState(i),console.log("🎯 Game state loaded with candidate blocks:",i.candidateBlocks.length)),this.audioManager.isAudioReady&&this.audioManager.playSuccessSound()}))}startGameLoop(){this.app.ticker.add((e=>{this.gameEngine.update(e),this.sceneManager.update(e),this.inputManager.update()}))}get gameState(){return this.gameEngine.gameState}get pixiApp(){return this.app}resize(e,t){this.screenWidth=e,this.screenHeight=t,this.app.renderer.resize(e,t),this.sceneManager.resize(e,t)}getGameEngine(){return this.gameEngine}handleSpacePressed(){this.gameStarted?console.log("⏸️ Toggling pause..."):console.log("🎮 请使用界面按钮选择游戏模式和难度来开始游戏")}handleEscapePressed(){this.gameStarted?console.log("⏸️ Pausing game..."):console.log("🚪 Showing menu...")}handleCanvasClick(e,t){console.log(`🎯 Canvas clicked at (${e}, ${t})`),this.gameStarted?console.log("🎲 Processing game click..."):console.log('🎮 请点击"进入游戏"按钮选择模式和难度后开始游戏')}handleMouseMove(e,t){}destroy(){this.app.destroy(!0),this.gameEngine.destroy(),this.sceneManager.destroy(),this.inputManager.destroy(),this.audioManager.destroy()}}(L);window.addEventListener("resize",(()=>{const e=k();F.resize(e.width,e.height),console.log(`🔄 Game resized to: ${e.width}x${e.height}`)})),async function(){try{"loading"===document.readyState&&await new Promise((e=>{document.addEventListener("DOMContentLoaded",e)}));const e=document.querySelector(".loading");e&&e.remove(),await F.init(),window.gameApp=F,console.log("🎮 Game initialized successfully"),B.isMobile()&&function(){window.addEventListener("orientationchange",(()=>{setTimeout((()=>{console.log("📱 Orientation changed, updating layout...");const e=k();F.resize(e.width,e.height)}),100)})),B.isMobile()&&function(){const e=document.createElement("button");e.innerHTML="⛶",e.style.cssText="\n    position: fixed;\n    top: 10px;\n    right: 10px;\n    z-index: 1000;\n    background: rgba(0, 212, 255, 0.8);\n    border: none;\n    border-radius: 5px;\n    color: white;\n    padding: 8px 12px;\n    font-size: 16px;\n    cursor: pointer;\n    font-family: monospace;\n  ",e.addEventListener("click",(async()=>{try{document.fullscreenElement?(await B.exitFullscreen(),e.innerHTML="⛶"):(await B.requestFullscreen(),e.innerHTML="⛶")}catch(t){console.warn("Fullscreen operation failed:",t)}})),document.body.appendChild(e)}();document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",document.body.style.touchAction="none"}()}catch(e){console.error("❌ Failed to initialize game:",e);const t=document.getElementById("app");t&&(t.innerHTML=`\n        <div style="color: #ff4444; text-align: center; padding: 20px;">\n          <h2>游戏初始化失败</h2>\n          <p>${e instanceof Error?e.message:"未知错误"}</p>\n          <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">重新加载</button>\n        </div>\n      `)}}(),import.meta;
